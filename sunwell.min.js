/**
 * Sunwell
 * =======
 * Sunwell is a renderer for hearthstone cards.
 *
 * @author Christian Engel <hello@wearekiss.com>
 */
(function(){function r(b){h.settings.debug&&console.log(b)}function u(){return t.length?t.pop():document.createElement("canvas")}function C(){if(B)return B;var b=u(),c=b.getContext("2d");b.width=b.height=512;c.save();c.fillStyle="grey";c.fillRect(0,0,512,512);c.fill();c.fillStyle="red";c.textAlign="center";c.textBaseline="middle";c.font="50px Belwe";c.fillText("missing artwork",256,256);c.restore();return B=b.toDataURL()}function n(b){return m[b]||B}function J(b,c,f,a,e){var d=a/2*.5522848,g=e/2*
.5522848,h=c+a,k=f+e;a=c+a/2;e=f+e/2;b.beginPath();b.moveTo(c,e);b.bezierCurveTo(c,e-g,a-d,f,a,f);b.bezierCurveTo(a+d,f,h,e-g,h,e);b.bezierCurveTo(h,e+g,a+d,k,a,k);b.bezierCurveTo(a-d,k,c,e+g,c,e);b.stroke()}function M(b){return new Promise(function(c){for(var f=0,a=1,e={},d,g,D,k,l=0;l<b.length;l++)d=b[l],D=g=!1,"h:"===d.substr(0,2)&&(g=!0,D=!!h.settings.smallTextureFolder,d=d.substr(2)),"t:"===d.substr(0,2)&&(g=!0,d=d.substr(2),void 0!==m[d]&&256===m[d].width&&(m[d]=void 0)),"u:"===d.substr(0,2)&&
(k=!0,d=d.substr(2)),void 0===m[d]?(m[d]=new Image,m[d].crossOrigin="Anonymous",m[d].loaded=!1,a++,function(b){m[b].addEventListener("load",function(){f++;m[b].loaded=!0;e[b]=m[b];m[b].width&&m[b].height||(m[b].src=C());f>=a&&c(e)});m[b].addEventListener("error",function(){f++;m[b].src=C();m[b].loaded=!0;e[b]=m[b];f>=a&&c(e)})}(d),k?m[d].src=d:g?(m[d].isTexture=!0,m[d].src=D?h.settings.smallTextureFolder+d+".jpg":h.settings.textureFolder+d+".jpg"):m[d].src=h.settings.assetFolder+d+".png"):(a++,m[d].loaded?
(f++,e[d]=m[d]):function(b){m[b].addEventListener("load",function(){f++;e[b]=m[b];f>=a&&c(e)})}(d));a--;0<f&&f>=a&&c(e)})}function E(b){var c=b.canvas.width,f=b.canvas.height;b=b.getImageData(0,0,c,f).data;var a,e,d=999,g=999,h=0,k=0,l=!1;for(e=f-1;-1<e&&!l;e--)for(a=0;a<c;a++)if(0<b[4*e*c+4*a+3]){k=Math.max(k,e);l=!0;break}if(void 0===k)return null;a=c-1;a:for(;-1<a;a--)for(e=0;e<f;e++)if(0<b[4*e*c+4*a+3]){h=Math.max(h,a);break a}a=0;a:for(;a<h;a++)for(e=0;e<f;e++)if(0<b[4*e*c+4*a+3]){d=Math.min(a,
d);break a}e=0;a:for(;e<k;e++)for(a=0;a<c;a++)if(0<b[4*e*c+4*a+3]){g=Math.min(g,e);break a}return{x:d,y:g,maxX:h,maxY:k,w:h-d,h:k-g}}function N(b,c,f){var a,e;a=h.races[f.language]?h.races[f.language][f.race]?h.races[f.language][f.race]:f.race:h.races.enUS[f.race]?h.races.enUS[f.race]:f.race;f=u();var d=f.getContext("2d");f.width=300;f.height=60;d.font="45px Belwe";d.lineCap="round";d.lineJoin="round";d.textBaseline="hanging";d.textAlign="left";a=a.split("");e=10;for(var g=0;g<a.length;g++)d.lineWidth=
8,d.strokeStyle="black",d.fillStyle="black",d.fillText(a[g],e,10),d.strokeText(a[g],e,10),d.fillStyle="white",d.strokeStyle="white",d.lineWidth=1,d.fillText(a[g],e,10),e+=d.measureText(a[g]).width;a=E(d);b.drawImage(f,a.x,a.y,a.w,a.h,(394-a.w/2)*c,(1001-a.h/2)*c,a.w*c,a.h*c);t.push(f)}function y(b,c,f,a,e,d,g,h){var k=u(),l=k.getContext("2d");void 0===g&&(g=e);k.width=256;k.height=256;e=e.toString();e=e.split("");var p=10;l.font=d+"px Belwe";l.lineCap="round";l.lineJoin="round";l.textBaseline="hanging";
l.textAlign="left";d="white";h?(e>g&&(d="#f00"),e<g&&(d="#0f0")):(e<g&&(d="#f00"),e>g&&(d="#0f0"));for(g=0;g<e.length;g++)l.lineWidth=13,l.strokeStyle="black",l.fillStyle="black",l.fillText(e[g],p,10),l.strokeText(e[g],p,10),l.fillStyle=d,l.strokeStyle=d,l.lineWidth=2.5,l.fillText(e[g],p,10),p+=l.measureText(e[g]).width;e=E(l);b.drawImage(k,e.x,e.y,e.w,e.h,(c-e.w/2)*a,(f-e.h/2)*a,e.w*a,e.h*a);t.push(k)}function K(b,c,f,a,e,d){h.settings.debug&&(b.save(),b.strokeStyle="red",b.beginPath(),b.moveTo(d/
2-a/2,e),b.lineTo(d/2+a/2,e),b.stroke(),b.restore());d=d/2-a/2;0>d&&(d=0);0<a&&0<c.width&&b.drawImage(c,0,0,a>c.width?c.width:a,c.height,d,e,Math.min(a,c.width),c.height);a=5;e+=c.height;f.clearRect(0,0,c.width,c.height);return[a,e]}function O(b,c,f){var a=u(),e=a.getContext("2d"),d=u(),g=d.getContext("2d"),m=f.textMarkdown.replace(/[\$#_]/g,"").split(" "),k,l,p=0,n=0,F,q,v,w;a.width=520;a.height=290;d.width=520;"SPELL"===f.type&&(a.width=460,a.height=290,d.width=460);"WEAPON"===f.type&&(a.width=
470,a.height=250,d.width=470);var x=h.settings.bodyFontSize;l=h.settings.bodyLineHeight;v=f.textMarkdown.replace(/\*\*/g,"").length;var r=!1;100<=v&&(x=.8*h.settings.bodyFontSize,l=.8*h.settings.bodyLineHeight);d.height=l;75<=v&&"SPELL"===f.type&&(r=!0);g.fillStyle="WEAPON"===f.type?"#fff":"#000";g.textBaseline="hanging";g.font=x+'px/1em "'+h.settings.bodyFont+'", sans-serif';l=g.measureText(" ").width;for(v=0;v<m.length;v++){k=m[v];f=k.split("");k=g.measureText(k).width;if(p+k>d.width-10||r&&p+k>
.8*d.width)r=!1,n=K(e,d,g,p,n,a.width),p=n[0],n=n[1];for(w=0;w<f.length;w++)k=f[w],"*"===k?"*"===f[w+1]?(F?(F=!1,g.font=" "+x+'px/1em "'+h.settings.bodyFont+'", sans-serif'):(F=!0,g.font="bold "+x+'px/1em "'+h.settings.bodyFont+'", sans-serif'),w+=1):q?(q=!1,g.font=" "+x+'px/1em "'+h.settings.bodyFont+'", sans-serif'):(q=!0,g.font="italic "+x+'px/1em "'+h.settings.bodyFont+'", sans-serif'):(g.fillText(k,p+h.settings.bodyFontOffset.x,h.settings.bodyFontOffset.y),p+=g.measureText(k).width+l/8);p+=l}K(e,
d,g,p,n,a.width);t.push(d);e=E(e);e.h=Math.ceil(e.h/d.height)*d.height;b.drawImage(a,e.x,e.y-2,e.w,e.h,(390-e.w/2)*c,(860-e.h/2)*c,e.w*c,(e.h+2)*c);t.push(a);h.settings.debug&&(b.save(),b.strokeStyle="green",b.beginPath(),b.rect((390-e.w/2)*c,(860-e.h/2)*c,e.w*c,(e.h+2)*c),b.stroke(),b.strokeStyle="red",b.beginPath(),b.rect((390-a.width/2)*c,(860-a.height/2)*c,a.width*c,(a.height+2)*c),b.stroke(),b.restore())}function G(b,c){return{x:Math.pow(1-c,3)*b[0].x+3*Math.pow(1-c,2)*c*b[1].x+3*(1-c)*Math.pow(c,
2)*b[2].x+Math.pow(c,3)*b[3].x,y:Math.pow(1-c,3)*b[0].y+3*Math.pow(1-c,2)*c*b[1].y+3*(1-c)*Math.pow(c,2)*b[2].y+Math.pow(c,3)*b[3].y,r:Math.atan2(3*Math.pow(1-c,2)*(b[1].y-b[0].y)+6*(1-c)*c*(b[2].y-b[1].y)+3*Math.pow(c,2)*(b[3].y-b[2].y),3*Math.pow(1-c,2)*(b[1].x-b[0].x)+6*(1-c)*c*(b[2].x-b[1].x)+3*Math.pow(c,2)*(b[3].x-b[2].x))}}function P(b,c,f){var a=u(),e=f.title;a.width=1024;a.height=200;var d=a.getContext("2d");d.save();var g=.58,m=580,k=[{x:0,y:110},{x:102,y:137},{x:368,y:16},{x:580,y:100}];
"SPELL"===f.type&&(g=.52,m=580,k=[{x:10,y:100},{x:212,y:35},{x:368,y:35},{x:570,y:105}]);"WEAPON"===f.type&&(g=.58,m=580,k=[{x:10,y:75},{x:50,y:75},{x:500,y:75},{x:570,y:75}]);f=51;d.lineWidth=13;d.strokeStyle="black";d.lineCap="round";d.lineJoin="round";d.textAlign="left";d.textBaseline="middle";for(var l=m+1;l>m&&10<f;){--f;d.font=f+"px Belwe";for(var p=l=0;p<e.length;p++)l+=d.measureText(e[p]).width+2;l*=1.25}l/=m;g-=l/2;m=l/e.length;h.settings.debug&&(d.save(),d.strokeStyle="red",d.lineWidth=
5,d.beginPath(),d.moveTo(k[0].x,k[0].y),d.bezierCurveTo(k[1].x,k[1].y,k[2].x,k[2].y,k[3].x,k[3].y),d.stroke(),d.restore());for(var n,q,p=l=0;p<e.length;p++){if(0===l)q=g+m*p,n=G(k,q),l=n.x;else for(q+=.01,n=G(k,q);n.x<l;)q+=.001,n=G(k,q);d.save();d.translate(n.x,n.y);d.scale(1.2,1);d.rotate(n.r);d.lineWidth=f/50*10;d.strokeStyle="black";d.fillStyle="black";d.fillText(e[p],0,0);d.strokeText(e[p],0,0);n=1.25*d.measureText(e[p]).width;l+=n;-1!==["i","f"].indexOf(e[p])&&(l+=.1*n);d.fillStyle="white";
d.strokeStyle="white";d.lineWidth=f/50*2.5;d.fillText(e[p],0,0);d.restore()}b.drawImage(a,0,0,580,200,105*c,525*c,580*c,200*c);t.push(a)}function Q(b,c,f,a,e){var d=f.sunwell,g,h,k=0;h=setTimeout(function(){console.log("Drawing timeout at point "+k+" in "+f.title);console.log(f);e&&e(b)},5E3);"string"===typeof f.texture?g=n(f.texture):f.texture instanceof Image?g=f.texture:(g=u(),g.width=f.texture.crop.w,g.height=f.texture.crop.h,g.getContext("2d").drawImage(f.texture.image,f.texture.crop.x,f.texture.crop.y,
f.texture.crop.w,f.texture.crop.h,0,0,g.width,g.height));k=2;c.save();c.clearRect(0,0,b.width,b.height);k=3;c.save();"MINION"===f.type&&(J(c,180*a,75*a,430*a,590*a),c.clip(),c.drawImage(g,0,0,g.width,g.height,100*a,75*a,590*a,590*a));"SPELL"===f.type&&(c.rect(125*a,165*a,529*a,434*a),c.clip(),c.drawImage(g,0,0,g.width,g.height,125*a,117*a,529*a,529*a));"WEAPON"===f.type&&(J(c,150*a,135*a,476*a,468*a),c.clip(),c.drawImage(g,0,0,g.width,g.height,150*a,135*a,476*a,476*a));c.restore();k=4;c.drawImage(n(d.cardBack),
0,0,764,1100,0,0,b.width,b.height);k=5;c.drawImage(n("gem"),0,0,182,180,24*a,82*a,182*a,180*a);k=6;"MINION"===f.type&&(d.rarity&&c.drawImage(n(d.rarity),0,0,146,146,326*a,607*a,146*a,146*a),c.drawImage(n("title"),0,0,608,144,94*a,546*a,608*a,144*a),f.race&&c.drawImage(n("race"),0,0,529,106,125*a,937*a,529*a,106*a),c.drawImage(n("attack"),0,0,214,238,0,862*a,214*a,238*a),c.drawImage(n("health"),0,0,167,218,575*a,876*a,167*a,218*a),"LEGENDARY"===f.rarity&&c.drawImage(n("dragon"),0,0,569,417,196*a,0,
569*a,417*a));k=7;"SPELL"===f.type&&(d.rarity&&c.drawImage(n(d.rarity),0,0,149,149,311*a,607*a,150*a,150*a),c.drawImage(n("title-spell"),0,0,646,199,66*a,530*a,646*a,199*a));"WEAPON"===f.type&&(d.rarity&&c.drawImage(n(d.rarity),0,0,146,144,315*a,592*a,146*a,144*a),c.drawImage(n("title-weapon"),0,0,660,140,56*a,551*a,660*a,140*a),c.drawImage(n("swords"),0,0,312,306,32*a,906*a,187*a,183*a),c.drawImage(n("shield"),0,0,301,333,584*a,890*a,186*a,205*a));k=8;"CORE"!==f.set&&function(){var b;"SPELL"===f.type&&
(b=265);"MINION"===f.type&&(b=265);f.race&&"MINION"===f.type?c.drawImage(n(d.bgLogo),0,0,281,244,b*a,734*a,266.95*a,244*.95*a):"SPELL"===f.type?c.drawImage(n(d.bgLogo),0,0,281,244,b*a,740*a,253*a,220*a):c.drawImage(n(d.bgLogo),0,0,281,244,b*a,734*a,281*a,244*a)}();k=9;k=10;y(c,116,170,a,f.cost||0,170,f._originalCost,!0);k=11;P(c,a,f);k=12;"MINION"===f.type&&(f.race&&N(c,a,f),y(c,128,994,a,f.attack||0,150,f._originalAttack),y(c,668,994,a,f.health||0,150,f._originalHealth));k=13;"WEAPON"===f.type&&
(y(c,128,994,a,f.attack||0,150,f._originalAttack),y(c,668,994,a,f.durability||0,150,f._originalDurability));k=14;O(c,a,f);c.restore();clearTimeout(h);e&&e(b)}function H(b,c,f){z.push([b,c,f]);A||I()}function I(){L&&(R(),window.requestAnimationFrame(I))}function R(){if(!(12<A)){var b,c,f;if(z.length){var a=z.shift();A++;b=a[0];c=a[1];f=a[2];r("Preparing assets for: "+b.title);var e=u(),d=e.getContext("2d"),g=(c||512)/764,a=[];e.width=c||512;e.height=Math.round(1.4397905759*e.width);b.sunwell=b.sunwell||
{};b.sunwell.cardBack=b.type.substr(0,1).toLowerCase()+b.playerClass.substr(0,1)+b.playerClass.substr(1).toLowerCase();a.push(b.sunwell.cardBack);a.push("gem");"MINION"===b.type&&(a.push("attack","health","title"),"LEGENDARY"===b.rarity&&a.push("dragon"),"FREE"===b.rarity||"COMMON"===b.rarity&&"CORE"===b.set||(b.sunwell.rarity="rarity-"+b.rarity.toLowerCase(),a.push(b.sunwell.rarity)));"SPELL"===b.type&&(a.push("attack","health","title-spell"),"FREE"===b.rarity||"COMMON"===b.rarity&&"CORE"===b.set||
(b.sunwell.rarity="spell-rarity-"+b.rarity.toLowerCase(),a.push(b.sunwell.rarity)));"WEAPON"===b.type&&(a.push("swords","shield","title-weapon"),"FREE"===b.rarity||"COMMON"===b.rarity&&"CORE"===b.set||(b.sunwell.rarity="weapon-rarity-"+b.rarity.toLowerCase(),a.push(b.sunwell.rarity)));-1==="BRM GVG LOE NAX TGT WOG".split(" ").indexOf(b.set)?b.sunwell.bgLogo="bg-cl":b.sunwell.bgLogo="bg-"+b.set.toLowerCase();"SPELL"===b.type&&(b.sunwell.bgLogo="spell-"+b.sunwell.bgLogo);a.push(b.sunwell.bgLogo);b.race&&
a.push("race");"string"===typeof b.texture&&"CHEAT"!==b.set&&(.5>=g?a.push("h:"+b.texture):a.push("t:"+b.texture));r("Assets prepared, now loading");M(a).then(function(){r("Assets loaded for: "+b.title);Q(e,d,b,g,f);A--;r("Card rendered: "+b.title);t.push(e)})}}}var h,m={},L=!1,z=[],A=0,q={},t=[],S=["COMMON","RARE","EPIC","LEGENDARY"],B;window.sunwell=h=window.sunwell||{};h._buffers=t;h._renderQuery=z;h._activeRenders=A;h.settings=h.settings||{};h.settings.titleFont=h.settings.titleFont||"Belwe Bold";
h.settings.bodyFont=h.settings.bodyFont||"ITC Franklin Condensed";h.settings.bodyFontSize=h.settings.bodyFontSize||60;h.settings.bodyFontOffset=h.settings.bodyFontOffset||{x:0,y:0};h.settings.bodyLineHeight=h.settings.bodyLineHeight||50;h.settings.assetFolder=h.settings.assetFolder||"/assets/";h.settings.textureFolder=h.settings.textureFolder||"/artwork/";h.settings.smallTextureFolder=h.settings.smallTextureFolder||null;h.settings.autoInit=h.settings.autoInit||!0;h.settings.idAsTexture=h.settings.idAsTexture||
!1;h.settings.debug=h.settings.debug||!1;h.init=function(){L=!0;z.length&&I()};h.settings.autoInit||h.init();h.races={enUS:{MURLOC:"Murloc",MECHANICAL:"Mech",BEAST:"Beast",DEMON:"Demon",PIRATE:"Pirate",DRAGON:"Dragon",TOTEM:"Totem"},deDE:{MURLOC:"Murloc",MECHANICAL:"Mech",BEAST:"Wildtier",DEMON:"D\u00e4mon",PIRATE:"Pirat",DRAGON:"Drache",TOTEM:"Totem"}};m.empty=new Image;m.empty.src=C();h.clearCache=function(){q={}};h.createCard=function(b,c,f){if(!b)throw Error("No card object given");f||(f=new Image);
-1===S.indexOf(b.rarity)&&(b.rarity="FREE");void 0===b.title&&(b.title=b.name);void 0===b.gameId&&(b.gameId=b.id);void 0===b.textMarkdown&&(b.textMarkdown=b.text.replace(/<\/*b>/g,"**"));h.settings.idAsTexture&&(b.texture=b.gameId);var a=c+"_"+b.language+"_"+b.gameId+"_"+b.cost+"_"+b.attack+"_"+b.health;b._originalCost=b.cost;b._originalHealth=b.health;b._originalAttack=b.attack;b._originalDurability=b.durability;if(q[a])f.src=q[a];else return r("Queried render: "+b.title),H(b,c,function(b){f.src=
q[a]=b.toDataURL()}),{target:f,redraw:function(){a=c+"_"+b.language+"_"+b.gameId+"_"+b.cost+"_"+b.attack+"_"+b.health+"_"+b.health;delete q[a];H(b,c,function(b){f.src=q[a]=b.toDataURL()})},update:function(e){for(var d in e)b[d]=e[d];a=c+"_"+b.language+"_"+b.gameId+"_"+b.cost+"_"+b.attack+"_"+b.health+"_"+b.health;q[a]?f.src=q[a]:H(b,c,function(b){f.src=q[a]=b.toDataURL()})}}}})();