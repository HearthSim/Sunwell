/**
 * Sunwell
 * =======
 * Sunwell is a renderer for hearthstone cards.
 *
 * @author Christian Engel <hello@wearekiss.com>
 */
(function(){function r(b){g.settings.debug&&console.log(b)}function z(){return x.length?x.pop():document.createElement("canvas")}function C(b){r("Substitute for "+b);if(v)return v;b=z();var c=b.getContext("2d");b.width=b.height=512;c.save();c.fillStyle="grey";c.fillRect(0,0,512,512);c.fill();c.fillStyle="red";c.textAlign="center";c.textBaseline="middle";c.font="50px Belwe";c.fillText("missing artwork",256,256);c.restore();v=new Image;v.src=b.toDataURL();return v}function n(b){return k[b]||C(b)}function D(b){var c,
d="",a=305419896;for(c in b)d=d+c+b[c];for(b=0;b<d.length;b++)a+=d.charCodeAt(b)*(b+1);return a}function J(b,c,d,a,e){var f=a/2*.5522848,l=e/2*.5522848,g=c+a,m=d+e;a=c+a/2;e=d+e/2;b.beginPath();b.moveTo(c,e);b.bezierCurveTo(c,e-l,a-f,d,a,d);b.bezierCurveTo(a+f,d,g,e-l,g,e);b.bezierCurveTo(g,e+l,a+f,m,a,m);b.bezierCurveTo(a-f,m,c,e+l,c,e);b.stroke()}function L(b){return new Promise(function(c){for(var d=0,a=1,e={},f,l,q,m,h=0;h<b.length;h++)f=b[h],q=l=!1,"h:"===f.substr(0,2)&&(l=!0,q=!!g.settings.smallTextureFolder,
f=f.substr(2)),"t:"===f.substr(0,2)&&(l=!0,f=f.substr(2),void 0!==k[f]&&256===k[f].width&&(k[f]=void 0)),"u:"===f.substr(0,2)&&(m=!0,f=f.substr(2)),void 0===k[f]?(k[f]=new Image,k[f].crossOrigin="Anonymous",k[f].loaded=!1,a++,function(b){k[b].addEventListener("load",function(){d++;k[b].loaded=!0;e[b]=k[b];k[b].width&&k[b].height||(k[b].src=C().src);d>=a&&c(e)});k[b].addEventListener("error",function(){d++;k[b].src=C().src;k[b].loaded=!0;e[b]=k[b];d>=a&&c(e)})}(f),m?k[f].src=f:(l?(k[f].isTexture=!0,
l=q?g.settings.smallTextureFolder+f+".jpg":g.settings.textureFolder+f+".jpg"):l=g.settings.assetFolder+f+".png",r("Requesting "+l),k[f].src=l)):(a++,k[f].loaded?(d++,e[f]=k[f]):function(b){k[b].addEventListener("load",function(){d++;e[b]=k[b];d>=a&&c(e)})}(f));a--;0<d&&d>=a&&c(e)})}function E(b){var c=b.canvas.width,d=b.canvas.height;b=b.getImageData(0,0,c,d).data;var a,e,f=999,l=999,g=0,m=0,h=!1;for(e=d-1;-1<e&&!h;e--)for(a=0;a<c;a++)if(0<b[4*e*c+4*a+3]){m=Math.max(m,e);h=!0;break}if(void 0===m)return null;
a=c-1;a:for(;-1<a;a--)for(e=0;e<d;e++)if(0<b[4*e*c+4*a+3]){g=Math.max(g,a);break a}a=0;a:for(;a<g;a++)for(e=0;e<d;e++)if(0<b[4*e*c+4*a+3]){f=Math.min(a,f);break a}e=0;a:for(;e<m;e++)for(a=0;a<c;a++)if(0<b[4*e*c+4*a+3]){l=Math.min(l,e);break a}return{x:f,y:l,maxX:g,maxY:m,w:g-f,h:m-l}}function M(b,c,d){var a,e;a=g.races[d.language]?g.races[d.language][d.race]?g.races[d.language][d.race]:d.race:g.races.enUS[d.race]?g.races.enUS[d.race]:d.race;d=z();var f=d.getContext("2d");d.width=300;d.height=60;f.font=
"45px Belwe";f.lineCap="round";f.lineJoin="round";f.textBaseline="hanging";f.textAlign="left";a=a.split("");e=10;for(var l=0;l<a.length;l++)f.lineWidth=8,f.strokeStyle="black",f.fillStyle="black",f.fillText(a[l],e,10),f.strokeText(a[l],e,10),f.fillStyle="white",f.strokeStyle="white",f.lineWidth=1,f.fillText(a[l],e,10),e+=f.measureText(a[l]).width;a=E(f);b.drawImage(d,a.x,a.y,a.w,a.h,(394-a.w/2)*c,(1001-a.h/2)*c,a.w*c,a.h*c);x.push(d)}function w(b,c,d,a,e,f,l){var g=z(),m=g.getContext("2d");void 0===
l&&(l="0");g.width=256;g.height=256;e=e.toString();e=e.split("");var h=10;m.font=f+"px Belwe";m.lineCap="round";m.lineJoin="round";m.textBaseline="hanging";m.textAlign="left";f="white";"-"===l&&(f="#f00");"+"===l&&(f="#0f0");for(l=0;l<e.length;l++)m.lineWidth=13,m.strokeStyle="black",m.fillStyle="black",m.fillText(e[l],h,10),m.strokeText(e[l],h,10),m.fillStyle=f,m.strokeStyle=f,m.lineWidth=2.5,m.fillText(e[l],h,10),h+=m.measureText(e[l]).width;e=E(m);b.drawImage(g,e.x,e.y,e.w,e.h,(c-e.w/2)*a,(d-e.h/
2)*a,e.w*a,e.h*a);x.push(g)}function F(b,c,d,a,e,f){g.settings.debug&&(b.save(),b.strokeStyle="red",b.beginPath(),b.moveTo(f/2-a/2,e),b.lineTo(f/2+a/2,e),b.stroke(),b.restore());f=f/2-a/2;0>f&&(f=0);0<a&&0<c.width&&b.drawImage(c,0,0,a>c.width?c.width:a,c.height,f,e,Math.min(a,c.width),c.height);a=5;e+=c.height;d.clearRect(0,0,c.width,c.height);return[a,e]}function N(b,c,d){var a="[x]"===d.text.substr(0,3),e=z(),f=e.getContext("2d"),l=z(),q=l.getContext("2d"),m=(a?d.text.substr(3):d.text).replace(/[\$#_]/g,
"").split(/( |\n)/g),h,u,p=0,k=0,n=0,t=0,A,v;r("Rendering body: "+d.textMarkdown);e.width=520;e.height=290;l.width=520;"SPELL"===d.type&&(e.width=460,e.height=290,l.width=460);"WEAPON"===d.type&&(e.width=470,e.height=250,l.width=470);var w=g.settings.bodyFontSize;A=g.settings.bodyLineHeight;h=d.textMarkdown.replace(/\*\*/g,"").length;var y=!1;80<=h&&(w=.9*g.settings.bodyFontSize,A=.9*g.settings.bodyLineHeight);100<=h&&(w=.8*g.settings.bodyFontSize,A=.8*g.settings.bodyLineHeight);l.height=A;75<=h&&
"SPELL"===d.type&&(y=!0);q.fillStyle="WEAPON"===d.type?"#fff":"#000";q.textBaseline="hanging";q.font=w+'px/1em "'+g.settings.bodyFont+'", sans-serif';for(A=0;A<m.length;A++){h=m[A];d=h.split("");u=q.measureText(h).width;r("Next word: "+h);!a&&(p+u>l.width||y&&p+u>.8*l.width)&&(r(p+u+" > "+l.width),r("Calculated line break"),y=!1,k=F(f,l,q,p,k,e.width),p=k[0],k=k[1],v=!0);for(h=0;h<d.length;h++)u=d[h],r(u+" "+u.charCodeAt(0)),10===u.charCodeAt(0)?v?v=!1:(k=F(f,l,q,p,k,e.width),p=k[0],k=k[1],r("Manual line break")):
(v=!1,"<"===u?("/"===d[h+1]?("b"===d[h+2]&&(n--,h+=3),"i"===d[h+2]&&(t--,h+=3)):("b"===d[h+1]&&(n++,h+=2),"i"===d[h+1]&&(t++,h+=2)),q.font=(0<n?"bold ":"")+(0<t?"italic":"")+" "+w+'px/1em "'+g.settings.bodyFont+'", sans-serif'):(q.fillText(u,p+g.settings.bodyFontOffset.x,g.settings.bodyFontOffset.y),p+=q.measureText(u).width+.375));p+=3}F(f,l,q,p,k,e.width);x.push(l);a=E(f);a.h=Math.ceil(a.h/l.height)*l.height;b.drawImage(e,a.x,a.y-2,a.w,a.h,(390-a.w/2)*c,(860-a.h/2)*c,a.w*c,(a.h+2)*c);x.push(e);
g.settings.debug&&(b.save(),b.strokeStyle="green",b.beginPath(),b.rect((390-a.w/2)*c,(860-a.h/2)*c,a.w*c,(a.h+2)*c),b.stroke(),b.strokeStyle="red",b.beginPath(),b.rect((390-e.width/2)*c,(860-e.height/2)*c,e.width*c,(e.height+2)*c),b.stroke(),b.restore())}function G(b,c){return{x:Math.pow(1-c,3)*b[0].x+3*Math.pow(1-c,2)*c*b[1].x+3*(1-c)*Math.pow(c,2)*b[2].x+Math.pow(c,3)*b[3].x,y:Math.pow(1-c,3)*b[0].y+3*Math.pow(1-c,2)*c*b[1].y+3*(1-c)*Math.pow(c,2)*b[2].y+Math.pow(c,3)*b[3].y,r:Math.atan2(3*Math.pow(1-
c,2)*(b[1].y-b[0].y)+6*(1-c)*c*(b[2].y-b[1].y)+3*Math.pow(c,2)*(b[3].y-b[2].y),3*Math.pow(1-c,2)*(b[1].x-b[0].x)+6*(1-c)*c*(b[2].x-b[1].x)+3*Math.pow(c,2)*(b[3].x-b[2].x))}}function O(b,c,d){var a=z(),e=d.title;a.width=1024;a.height=200;var f=a.getContext("2d");f.save();var l=.58,q=580,m=[{x:0,y:110},{x:102,y:137},{x:368,y:16},{x:580,y:100}];"SPELL"===d.type&&(l=.52,q=580,m=[{x:10,y:100},{x:212,y:35},{x:368,y:35},{x:570,y:105}]);"WEAPON"===d.type&&(l=.58,q=580,m=[{x:10,y:75},{x:50,y:75},{x:500,y:75},
{x:570,y:75}]);d=51;f.lineWidth=13;f.strokeStyle="black";f.lineCap="round";f.lineJoin="round";f.textAlign="left";f.textBaseline="middle";for(var h=q+1;h>q&&10<d;){--d;f.font=d+"px Belwe";for(var k=h=0;k<e.length;k++)h+=f.measureText(e[k]).width+2;h*=1.25}h/=q;l-=h/2;q=h/e.length;g.settings.debug&&(f.save(),f.strokeStyle="red",f.lineWidth=5,f.beginPath(),f.moveTo(m[0].x,m[0].y),f.bezierCurveTo(m[1].x,m[1].y,m[2].x,m[2].y,m[3].x,m[3].y),f.stroke(),f.restore());for(var p,n,k=h=0;k<e.length;k++){if(0===
h)n=l+q*k,p=G(m,n),h=p.x;else for(n+=.01,p=G(m,n);p.x<h;)n+=.001,p=G(m,n);f.save();f.translate(p.x,p.y);f.scale(1.2,1);f.rotate(p.r);f.lineWidth=d/50*10;f.strokeStyle="black";f.fillStyle="black";f.fillText(e[k],0,0);f.strokeText(e[k],0,0);p=1.25*f.measureText(e[k]).width;h+=p;-1!==["i","f"].indexOf(e[k])&&(h+=.1*p);f.fillStyle="white";f.strokeStyle="white";f.lineWidth=d/50*2.5;f.fillText(e[k],0,0);f.restore()}b.drawImage(a,0,0,580,200,105*c,525*c,580*c,200*c);x.push(a)}function P(b,c,d,a,e,f){var g=
d.sunwell,k,m,h=0,t=Date.now();m=setTimeout(function(){r("Drawing timeout at point "+h+" in "+d.title);r(d);f();e&&e(b)},5E3);"string"===typeof d.texture?k=n(d.texture):d.texture instanceof Image?k=d.texture:(k=z(),k.width=d.texture.crop.w,k.height=d.texture.crop.h,k.getContext("2d").drawImage(d.texture.image,d.texture.crop.x,d.texture.crop.y,d.texture.crop.w,d.texture.crop.h,0,0,k.width,k.height));k||(k=n("~"));h=2;c.save();c.clearRect(0,0,b.width,b.height);h=3;c.save();"MINION"===d.type&&(J(c,180*
a,75*a,430*a,590*a),c.clip(),c.fillStyle="grey",c.fillRect(0,0,765*a,1100*a),c.drawImage(k,0,0,k.width,k.height,100*a,75*a,590*a,590*a));"SPELL"===d.type&&(c.rect(125*a,165*a,529*a,434*a),c.clip(),c.fillStyle="grey",c.fillRect(0,0,765*a,1100*a),c.drawImage(k,0,0,k.width,k.height,125*a,117*a,529*a,529*a));"WEAPON"===d.type&&(J(c,150*a,135*a,476*a,468*a),c.clip(),c.fillStyle="grey",c.fillRect(0,0,765*a,1100*a),c.drawImage(k,0,0,k.width,k.height,150*a,135*a,476*a,476*a));c.restore();h=4;c.drawImage(n(g.cardBack),
0,0,764,1100,0,0,b.width,b.height);h=5;c.drawImage(n("gem"),0,0,182,180,24*a,82*a,182*a,180*a);h=6;"MINION"===d.type&&(g.rarity&&c.drawImage(n(g.rarity),0,0,146,146,326*a,607*a,146*a,146*a),c.drawImage(n("title"),0,0,608,144,94*a,546*a,608*a,144*a),d.race&&c.drawImage(n("race"),0,0,529,106,125*a,937*a,529*a,106*a),c.drawImage(n("attack"),0,0,214,238,0,862*a,214*a,238*a),c.drawImage(n("health"),0,0,167,218,575*a,876*a,167*a,218*a),"LEGENDARY"===d.rarity&&c.drawImage(n("dragon"),0,0,569,417,196*a,0,
569*a,417*a));h=7;"SPELL"===d.type&&(g.rarity&&c.drawImage(n(g.rarity),0,0,149,149,311*a,607*a,150*a,150*a),c.drawImage(n("title-spell"),0,0,646,199,66*a,530*a,646*a,199*a));"WEAPON"===d.type&&(g.rarity&&c.drawImage(n(g.rarity),0,0,146,144,315*a,592*a,146*a,144*a),c.drawImage(n("title-weapon"),0,0,660,140,56*a,551*a,660*a,140*a),c.drawImage(n("swords"),0,0,312,306,32*a,906*a,187*a,183*a),c.drawImage(n("shield"),0,0,301,333,584*a,890*a,186*a,205*a));h=8;"CORE"!==d.set&&function(){var b;"SPELL"===d.type&&
(b=265);"MINION"===d.type&&(b=265);d.race&&"MINION"===d.type?c.drawImage(n(g.bgLogo),0,0,281,244,b*a,734*a,266.95*a,244*.95*a):"SPELL"===d.type?c.drawImage(n(g.bgLogo),0,0,281,244,b*a,740*a,253*a,220*a):c.drawImage(n(g.bgLogo),0,0,281,244,b*a,734*a,281*a,244*a)}();h=9;h=10;w(c,116,170,a,d.cost||0,170,d.costStyle);h=11;O(c,a,d);h=12;"MINION"===d.type&&(d.race&&M(c,a,d),w(c,128,994,a,d.attack||0,150,d.attackStyle),w(c,668,994,a,d.health||0,150,d.healthStyle));h=13;"WEAPON"===d.type&&(w(c,128,994,a,
d.attack||0,150,d.attackStyle),w(c,668,994,a,d.durability||0,150,d.durabilityStyle));h=14;d.silenced&&"MINION"===d.type?c.drawImage(n("silence-x"),0,0,410,397,200*a,660*a,410*a,397*a):N(c,a,d);c.restore();clearTimeout(m);r("Rendertime: "+(Date.now()-t)+"ms");f();e&&e(b)}function H(b,c,d){y.push([b,c,d]);B||I()}function I(){K&&(Q(),window.requestAnimationFrame(I))}function Q(){if(!(12<B)){var b,c,d;if(y.length){var a=y.shift();B++;b=a[0];c=a[1];d=a[2];r("Preparing assets for: "+b.title);var e=z(),
f=e.getContext("2d"),g=(c||512)/764,a=["silence-x"];e.width=c||512;e.height=Math.round(1.4397905759*e.width);b.sunwell=b.sunwell||{};b.sunwell.cardBack=b.type.substr(0,1).toLowerCase()+b.playerClass.substr(0,1)+b.playerClass.substr(1).toLowerCase();a.push(b.sunwell.cardBack);a.push("gem");"MINION"===b.type&&(a.push("attack","health","title"),"LEGENDARY"===b.rarity&&a.push("dragon"),"FREE"===b.rarity||"COMMON"===b.rarity&&"CORE"===b.set||(b.sunwell.rarity="rarity-"+b.rarity.toLowerCase(),a.push(b.sunwell.rarity)));
"SPELL"===b.type&&(a.push("attack","health","title-spell"),"FREE"===b.rarity||"COMMON"===b.rarity&&"CORE"===b.set||(b.sunwell.rarity="spell-rarity-"+b.rarity.toLowerCase(),a.push(b.sunwell.rarity)));"WEAPON"===b.type&&(a.push("swords","shield","title-weapon"),"FREE"===b.rarity||"COMMON"===b.rarity&&"CORE"===b.set||(b.sunwell.rarity="weapon-rarity-"+b.rarity.toLowerCase(),a.push(b.sunwell.rarity)));-1==="BRM GVG LOE NAX TGT OG".split(" ").indexOf(b.set)?b.sunwell.bgLogo="bg-cl":b.sunwell.bgLogo="bg-"+
b.set.toLowerCase();"SPELL"===b.type&&(b.sunwell.bgLogo="spell-"+b.sunwell.bgLogo);a.push(b.sunwell.bgLogo);b.race&&a.push("race");"string"===typeof b.texture&&"CHEAT"!==b.set&&(.5>=g?a.push("h:"+b.texture):a.push("t:"+b.texture));r("Assets prepared, now loading");L(a).then(function(){r("Assets loaded for: "+b.title);P(e,f,b,g,d,function(){B--;r("Card rendered: "+b.title);x.push(e)})})}}}var g,k={},K=!1,y=[],B=0,t={},x=[],R=["COMMON","RARE","EPIC","LEGENDARY"],v;window.sunwell=g=window.sunwell||{};
g._buffers=x;g._renderQuery=y;g._activeRenders=B;g.settings=g.settings||{};g.settings.titleFont=g.settings.titleFont||"Belwe Bold";g.settings.bodyFont=g.settings.bodyFont||"ITC Franklin Condensed";g.settings.bodyFontSize=g.settings.bodyFontSize||60;g.settings.bodyFontOffset=g.settings.bodyFontOffset||{x:0,y:0};g.settings.bodyLineHeight=g.settings.bodyLineHeight||50;g.settings.assetFolder=g.settings.assetFolder||"/assets/";g.settings.textureFolder=g.settings.textureFolder||"/artwork/";g.settings.smallTextureFolder=
g.settings.smallTextureFolder||null;g.settings.autoInit=g.settings.autoInit||!0;g.settings.idAsTexture=g.settings.idAsTexture||!1;g.settings.debug=g.settings.debug||!1;g.init=function(){K=!0;y.length&&I()};g.settings.autoInit||g.init();g.races={enUS:{MURLOC:"Murloc",MECHANICAL:"Mech",BEAST:"Beast",DEMON:"Demon",PIRATE:"Pirate",DRAGON:"Dragon",TOTEM:"Totem"},deDE:{MURLOC:"Murloc",MECHANICAL:"Mech",BEAST:"Wildtier",DEMON:"D\u00e4mon",PIRATE:"Pirat",DRAGON:"Drache",TOTEM:"Totem"}};g.clearCache=function(){t=
{}};g.createCard=function(b,c,d){if(!b)throw Error("No card object given");d||(d=new Image);-1===R.indexOf(b.rarity)&&(b.rarity="FREE");void 0===b.title&&(b.title=b.name);void 0===b.gameId&&(b.gameId=b.id);g.settings.idAsTexture&&(b.texture=b.gameId);b.costStyle=b.costStyle||"0";b.healthStyle=b.healthStyle||"0";b.attackStyle=b.attackStyle||"0";b.durabilityStyle=b.durabilityStyle||"0";b.silenced=b.silenced||!1;b.width=c;var a=D(b);if(t[a]&&!g.settings.debug)d.src=t[a];else return r("Queried render: "+
b.title),H(b,c,function(b){d.src=t[a]=b.toDataURL()}),{target:d,redraw:function(){a=D(b);delete t[a];H(b,c,function(b){d.src=t[a]=b.toDataURL()})},update:function(e){e.text&&(e.markdown=html2markdown(e.text));e.markdown&&(e.textMarkdown=e.textMarkdown.replace(/^\[x]/,""));for(var f in e)b[f]=e[f];a=D(b);t[a]?d.src=t[a]:H(b,c,function(b){d.src=t[a]=b.toDataURL()})}}}})();