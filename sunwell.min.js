/**
 * Sunwell
 * =======
 * Sunwell is a renderer for hearthstone cards.
 *
 * @author Christian Engel <hello@wearekiss.com>
 */
(function(){function r(b){f.settings.debug&&console.log(b)}function C(){return B.length?B.pop():document.createElement("canvas")}function F(b){r("Substitute for "+b);if(x)return x;if("string"===typeof f.settings.misingImg&&m[f.settings.misingImg].loaded)return x=m[f.settings.misingImg];b=C();var c=b.getContext("2d");b.width=b.height=512;c.save();c.fillStyle="grey";c.fillRect(0,0,512,512);c.fill();c.fillStyle="red";c.textAlign="center";c.textBaseline="middle";c.font="50px Belwe";c.fillText("missing artwork",
256,256);c.restore();x=new Image;x.src=b.toDataURL();return x}function n(b){return m[b]||F(b)}function G(b){var c,d="",a=305419896;for(c in b)d=d+c+b[c];for(b=0;b<d.length;b++)a+=d.charCodeAt(b)*(b+1);return a}function M(b,c,d,a,g){var e=a/2*.5522848,f=g/2*.5522848,h=c+a,k=d+g;a=c+a/2;g=d+g/2;b.beginPath();b.moveTo(c,g);b.bezierCurveTo(c,g-f,a-e,d,a,d);b.bezierCurveTo(a+e,d,h,g-f,h,g);b.bezierCurveTo(h,g+f,a+e,k,a,k);b.bezierCurveTo(a-e,k,c,g+f,c,g);b.stroke()}function N(b){return new Promise(function(c){for(var d=
0,a=1,g={},e,q,h,k,l=0;l<b.length;l++)e=b[l],h=q=!1,"h:"===e.substr(0,2)&&(q=!0,h=!!f.settings.smallTextureFolder,e=e.substr(2)),"t:"===e.substr(0,2)&&(q=!0,e=e.substr(2),void 0!==m[e]&&256===m[e].width&&(m[e]=void 0)),"u:"===e.substr(0,2)&&(k=!0,e=e.substr(2)),void 0===m[e]?(m[e]=new Image,m[e].crossOrigin="Anonymous",m[e].loaded=!1,a++,function(b){m[b].addEventListener("load",function(){d++;m[b].loaded=!0;g[b]=m[b];m[b].width&&m[b].height||(m[b].src=F().src);d>=a&&c(g)});m[b].addEventListener("error",
function(){d++;m[b].src=F().src;m[b].loaded=!0;g[b]=m[b];d>=a&&c(g)})}(e),k?m[e].src=e:(q?(m[e].isTexture=!0,q=h?f.settings.smallTextureFolder+e+".jpg":f.settings.textureFolder+e+".jpg"):q=f.settings.assetFolder+e+".png",r("Requesting "+q),m[e].src=q)):(a++,m[e].loaded?(d++,g[e]=m[e]):function(b){m[b].addEventListener("load",function(){d++;g[b]=m[b];d>=a&&c(g)})}(e));a--;0<d&&d>=a&&c(g)})}function H(b){var c=b.canvas.width,d=b.canvas.height;b=b.getImageData(0,0,c,d).data;var a,g,e=999,f=999,h=0,k=
0,l=!1;for(g=d-1;-1<g&&!l;g--)for(a=0;a<c;a++)if(0<b[4*g*c+4*a+3]){k=Math.max(k,g);l=!0;break}if(void 0===k)return null;a=c-1;a:for(;-1<a;a--)for(g=0;g<d;g++)if(0<b[4*g*c+4*a+3]){h=Math.max(h,a);break a}a=0;a:for(;a<h;a++)for(g=0;g<d;g++)if(0<b[4*g*c+4*a+3]){e=Math.min(a,e);break a}g=0;a:for(;g<k;g++)for(a=0;a<c;a++)if(0<b[4*g*c+4*a+3]){f=Math.min(f,g);break a}return{x:e,y:f,maxX:h,maxY:k,w:h-e,h:k-f}}function Q(b,c,d){var a,g;a=f.races[d.language]?f.races[d.language][d.race]?f.races[d.language][d.race]:
d.race:f.races.enUS[d.race]?f.races.enUS[d.race]:d.race;d=C();var e=d.getContext("2d");d.width=300;d.height=60;e.font="45px Belwe";e.lineCap="round";e.lineJoin="round";e.textBaseline="hanging";e.textAlign="left";a=a.split("");g=10;for(var q=0;q<a.length;q++)e.lineWidth=8,e.strokeStyle="black",e.fillStyle="black",e.fillText(a[q],g,10),e.strokeText(a[q],g,10),e.fillStyle="white",e.strokeStyle="white",e.lineWidth=1,e.fillText(a[q],g,10),g+=e.measureText(a[q]).width;a=H(e);b.drawImage(d,a.x,a.y,a.w,a.h,
(394-a.w/2)*c,(1001-a.h/2)*c,a.w*c,a.h*c);B.push(d)}function y(b,c,d,a,g,e,f){var h=C(),k=h.getContext("2d");void 0===f&&(f="0");h.width=256;h.height=256;g=g.toString();g=g.split("");var l=10;k.font=e+"px Belwe";k.lineCap="round";k.lineJoin="round";k.textBaseline="hanging";k.textAlign="left";e="white";"-"===f&&(e="#f00");"+"===f&&(e="#0f0");for(f=0;f<g.length;f++)k.lineWidth=13,k.strokeStyle="black",k.fillStyle="black",k.fillText(g[f],l,10),k.strokeText(g[f],l,10),k.fillStyle=e,k.strokeStyle=e,k.lineWidth=
2.5,k.fillText(g[f],l,10),l+=k.measureText(g[f]).width;g=H(k);b.drawImage(h,g.x,g.y,g.w,g.h,(c-g.w/2)*a,(d-g.h/2)*a,g.w*a,g.h*a);B.push(h)}function I(b,c,d,a,g,e){f.settings.debug&&(b.save(),b.strokeStyle="red",b.beginPath(),b.moveTo(e/2-a/2,g),b.lineTo(e/2+a/2,g),b.stroke(),b.restore());e=e/2-a/2;0>e&&(e=0);0<a&&0<c.width&&b.drawImage(c,0,0,a>c.width?c.width:a,c.height,e,g,Math.min(a,c.width),c.height);a=5;g+=c.height;d.clearRect(0,0,c.width,c.height);return[a,g]}function O(b,c,d,a){var g="[x]"===
d.text.substr(0,3),e=C(),q=e.getContext("2d"),h=C(),k=h.getContext("2d"),l=g?d.text.substr(3):d.text,m,p,v,n,t=0,w=0,u=0,x=0,D,y,A=0,z;for(z=l;null!==(m=R.exec(l));)z=z.replace(m[0],m[1]+m[2]+(1===parseInt(m[1],10)?m[3]:m[4]));l=z;m=l.replace(/[\$#_]/g,"").split(/( |\n)/g);r("Rendering body: "+l);e.width=520;e.height=290;h.width=520;"SPELL"===d.type&&(e.width=460,e.height=290,h.width=460);"WEAPON"===d.type&&(e.width=470,e.height=250,h.width=470);l=f.settings.bodyFontSize;v=f.settings.bodyLineHeight;
D=d.text.replace(/<\/*.>/g,"").length;z=!1;80<=D&&(l=.9*f.settings.bodyFontSize,v=.9*f.settings.bodyLineHeight);100<=D&&(l=.8*f.settings.bodyFontSize,v=.8*f.settings.bodyLineHeight);h.height=v;75<=D&&"SPELL"===d.type&&(z=!0);a&&(z=!0);k.fillStyle="WEAPON"===d.type?"#fff":"#000";k.textBaseline="hanging";k.font=l+'px/1em "'+f.settings.bodyFont+'", sans-serif';for(D=0;D<m.length;D++){p=m[D];v=p.split("");n=k.measureText(p).width;r("Next word: "+p);!g&&(t+n>h.width||z&&t+n>.8*h.width)&&(r(t+n+" > "+h.width),
r("Calculated line break"),z=!1,A++,w=I(q,h,k,t,w,e.width),t=w[0],w=w[1],y=!0);for(p=0;p<v.length;p++)n=v[p],r(n+" "+n.charCodeAt(0)),10===n.charCodeAt(0)?y?y=!1:(A++,w=I(q,h,k,t,w,e.width),t=w[0],w=w[1],r("Manual line break")):(y=!1,"<"===n?("/"===v[p+1]?("b"===v[p+2]&&(u--,p+=3),"i"===v[p+2]&&(x--,p+=3)):("b"===v[p+1]&&(u++,p+=2),"i"===v[p+1]&&(x++,p+=2)),k.font=(0<u?"bold ":"")+(0<x?"italic":"")+" "+l+'px/1em "'+f.settings.bodyFont+'", sans-serif'):(k.fillText(n,t+f.settings.bodyFontOffset.x,f.settings.bodyFontOffset.y),
t+=k.measureText(n).width+.375));t+=3}A++;I(q,h,k,t,w,e.width);B.push(h);"SPELL"!==d.type||4!==A||z||a?(d=H(q),d.h=Math.ceil(d.h/h.height)*h.height,b.drawImage(e,d.x,d.y-2,d.w,d.h,(390-d.w/2)*c,(860-d.h/2)*c,d.w*c,(d.h+2)*c),B.push(e),f.settings.debug&&(b.save(),b.strokeStyle="green",b.beginPath(),b.rect((390-d.w/2)*c,(860-d.h/2)*c,d.w*c,(d.h+2)*c),b.stroke(),b.strokeStyle="red",b.beginPath(),b.rect((390-e.width/2)*c,(860-e.height/2)*c,e.width*c,(e.height+2)*c),b.stroke(),b.restore())):O(b,c,d,!0)}
function J(b,c){return{x:Math.pow(1-c,3)*b[0].x+3*Math.pow(1-c,2)*c*b[1].x+3*(1-c)*Math.pow(c,2)*b[2].x+Math.pow(c,3)*b[3].x,y:Math.pow(1-c,3)*b[0].y+3*Math.pow(1-c,2)*c*b[1].y+3*(1-c)*Math.pow(c,2)*b[2].y+Math.pow(c,3)*b[3].y,r:Math.atan2(3*Math.pow(1-c,2)*(b[1].y-b[0].y)+6*(1-c)*c*(b[2].y-b[1].y)+3*Math.pow(c,2)*(b[3].y-b[2].y),3*Math.pow(1-c,2)*(b[1].x-b[0].x)+6*(1-c)*c*(b[2].x-b[1].x)+3*Math.pow(c,2)*(b[3].x-b[2].x))}}function S(b,c,d){var a=C(),g=d.title;a.width=1024;a.height=200;var e=a.getContext("2d");
e.save();var q=.58,h=580,k=[{x:0,y:110},{x:102,y:137},{x:368,y:16},{x:580,y:100}];"SPELL"===d.type&&(q=.52,h=580,k=[{x:10,y:100},{x:212,y:35},{x:368,y:35},{x:570,y:105}]);"WEAPON"===d.type&&(q=.58,h=580,k=[{x:10,y:75},{x:50,y:75},{x:500,y:75},{x:570,y:75}]);d=51;e.lineWidth=13;e.strokeStyle="black";e.lineCap="round";e.lineJoin="round";e.textAlign="left";e.textBaseline="middle";for(var l=h+1;l>h&&10<d;){--d;e.font=d+"px Belwe";for(var m=l=0;m<g.length;m++)l+=e.measureText(g[m]).width+2;l*=1.25}l/=
h;q-=l/2;h=l/g.length;f.settings.debug&&(e.save(),e.strokeStyle="red",e.lineWidth=5,e.beginPath(),e.moveTo(k[0].x,k[0].y),e.bezierCurveTo(k[1].x,k[1].y,k[2].x,k[2].y,k[3].x,k[3].y),e.stroke(),e.restore());for(var p,n,m=l=0;m<g.length;m++){if(0===l)n=q+h*m,p=J(k,n),l=p.x;else for(n+=.01,p=J(k,n);p.x<l;)n+=.001,p=J(k,n);e.save();e.translate(p.x,p.y);e.scale(1.2,1);e.rotate(p.r);e.lineWidth=d/50*10;e.strokeStyle="black";e.fillStyle="black";e.fillText(g[m],0,0);e.strokeText(g[m],0,0);p=1.25*e.measureText(g[m]).width;
l+=p;-1!==["i","f"].indexOf(g[m])&&(l+=.1*p);e.fillStyle="white";e.strokeStyle="white";e.lineWidth=d/50*2.5;e.fillText(g[m],0,0);e.restore()}b.drawImage(a,0,0,580,200,105*c,525*c,580*c,200*c);B.push(a)}function T(b,c,d,a,g,e){var f=d.sunwell,h,k,l=0,m=Date.now();k=setTimeout(function(){r("Drawing timeout at point "+l+" in "+d.title);r(d);e();g&&g(b)},5E3);"string"===typeof d.texture?h=n(d.texture):d.texture instanceof Image?h=d.texture:(h=C(),h.width=d.texture.crop.w,h.height=d.texture.crop.h,h.getContext("2d").drawImage(d.texture.image,
d.texture.crop.x,d.texture.crop.y,d.texture.crop.w,d.texture.crop.h,0,0,h.width,h.height));h||(h=n("~"));l=2;c.save();c.clearRect(0,0,b.width,b.height);l=3;c.save();"MINION"===d.type&&(M(c,180*a,75*a,430*a,590*a),c.clip(),c.fillStyle="grey",c.fillRect(0,0,765*a,1100*a),c.drawImage(h,0,0,h.width,h.height,100*a,75*a,590*a,590*a));"SPELL"===d.type&&(c.rect(125*a,165*a,529*a,434*a),c.clip(),c.fillStyle="grey",c.fillRect(0,0,765*a,1100*a),c.drawImage(h,0,0,h.width,h.height,125*a,117*a,529*a,529*a));"WEAPON"===
d.type&&(M(c,150*a,135*a,476*a,468*a),c.clip(),c.fillStyle="grey",c.fillRect(0,0,765*a,1100*a),c.drawImage(h,0,0,h.width,h.height,150*a,135*a,476*a,476*a));c.restore();l=4;c.drawImage(n(f.cardBack),0,0,764,1100,0,0,b.width,b.height);l=5;c.drawImage(n("gem"),0,0,182,180,24*a,82*a,182*a,180*a);l=6;"MINION"===d.type&&(f.rarity&&c.drawImage(n(f.rarity),0,0,146,146,326*a,607*a,146*a,146*a),c.drawImage(n("title"),0,0,608,144,94*a,546*a,608*a,144*a),d.race&&c.drawImage(n("race"),0,0,529,106,125*a,937*a,
529*a,106*a),c.drawImage(n("attack"),0,0,214,238,0,862*a,214*a,238*a),c.drawImage(n("health"),0,0,167,218,575*a,876*a,167*a,218*a),"LEGENDARY"===d.rarity&&c.drawImage(n("dragon"),0,0,569,417,196*a,0,569*a,417*a));l=7;"SPELL"===d.type&&(f.rarity&&c.drawImage(n(f.rarity),0,0,149,149,311*a,607*a,150*a,150*a),c.drawImage(n("title-spell"),0,0,646,199,66*a,530*a,646*a,199*a));"WEAPON"===d.type&&(f.rarity&&c.drawImage(n(f.rarity),0,0,146,144,315*a,592*a,146*a,144*a),c.drawImage(n("title-weapon"),0,0,660,
140,56*a,551*a,660*a,140*a),c.drawImage(n("swords"),0,0,312,306,32*a,906*a,187*a,183*a),c.drawImage(n("shield"),0,0,301,333,584*a,890*a,186*a,205*a));l=8;"CORE"!==d.set&&function(){var b;"SPELL"===d.type&&(b=265);"MINION"===d.type&&(b=265);d.race&&"MINION"===d.type?c.drawImage(n(f.bgLogo),0,0,281,244,b*a,734*a,266.95*a,244*.95*a):"SPELL"===d.type?c.drawImage(n(f.bgLogo),0,0,281,244,b*a,740*a,253*a,220*a):c.drawImage(n(f.bgLogo),0,0,281,244,b*a,734*a,281*a,244*a)}();l=9;l=10;y(c,116,170,a,d.cost||
0,170,d.costStyle);l=11;S(c,a,d);l=12;"MINION"===d.type&&(d.race&&Q(c,a,d),y(c,128,994,a,d.attack||0,150,d.attackStyle),y(c,668,994,a,d.health||0,150,d.healthStyle));l=13;"WEAPON"===d.type&&(y(c,128,994,a,d.attack||0,150,d.attackStyle),y(c,668,994,a,d.durability||0,150,d.durabilityStyle));l=14;d.silenced&&"MINION"===d.type?c.drawImage(n("silence-x"),0,0,410,397,200*a,660*a,410*a,397*a):O(c,a,d);c.restore();clearTimeout(k);r("Rendertime: "+(Date.now()-m)+"ms");e();g&&g(b)}function K(b,c,d){A.push([b,
c,d]);E||L()}function L(){P&&(U(),window.requestAnimationFrame(L))}function U(){if(!(12<E)){var b,c,d;if(A.length){var a=A.shift();E++;b=a[0];c=a[1];d=a[2];r("Preparing assets for: "+b.title);var g=C(),e=g.getContext("2d"),m=(c||512)/764,a=["silence-x"];g.width=c||512;g.height=Math.round(1.4397905759*g.width);b.sunwell=b.sunwell||{};b.sunwell.cardBack=b.type.substr(0,1).toLowerCase()+b.playerClass.substr(0,1)+b.playerClass.substr(1).toLowerCase();a.push(b.sunwell.cardBack);a.push("gem");"MINION"===
b.type&&(a.push("attack","health","title"),"LEGENDARY"===b.rarity&&a.push("dragon"),"FREE"===b.rarity||"COMMON"===b.rarity&&"CORE"===b.set||(b.sunwell.rarity="rarity-"+b.rarity.toLowerCase(),a.push(b.sunwell.rarity)));"SPELL"===b.type&&(a.push("attack","health","title-spell"),"FREE"===b.rarity||"COMMON"===b.rarity&&"CORE"===b.set||(b.sunwell.rarity="spell-rarity-"+b.rarity.toLowerCase(),a.push(b.sunwell.rarity)));"WEAPON"===b.type&&(a.push("swords","shield","title-weapon"),"FREE"===b.rarity||"COMMON"===
b.rarity&&"CORE"===b.set||(b.sunwell.rarity="weapon-rarity-"+b.rarity.toLowerCase(),a.push(b.sunwell.rarity)));-1===f.settings.sets.indexOf(b.set)?b.sunwell.bgLogo="bg-cl":b.sunwell.bgLogo="bg-"+b.set.toLowerCase();"SPELL"===b.type&&(b.sunwell.bgLogo="spell-"+b.sunwell.bgLogo);a.push(b.sunwell.bgLogo);b.race&&a.push("race");"string"===typeof b.texture&&"CHEAT"!==b.set&&(.5>=m?a.push("h:"+b.texture):a.push("t:"+b.texture));r("Assets prepared, now loading");N(a).then(function(){r("Assets loaded for: "+
b.title);T(g,e,b,m,d,function(){E--;r("Card rendered: "+b.title);B.push(g)})})}}}var f,m={},P=!1,A=[],E=0,u={},B=[],R=/(\d+)(.+?)\|4\((.+?),(.+?)\)/g,V=["COMMON","RARE","EPIC","LEGENDARY"],x;window.sunwell=f=window.sunwell||{};f._buffers=B;f._renderQuery=A;f._activeRenders=E;f.settings=f.settings||{};f.settings.titleFont=f.settings.titleFont||"Belwe Bold";f.settings.bodyFont=f.settings.bodyFont||"ITC Franklin Condensed";f.settings.bodyFontSize=f.settings.bodyFontSize||60;f.settings.bodyFontOffset=
f.settings.bodyFontOffset||{x:0,y:0};f.settings.bodyLineHeight=f.settings.bodyLineHeight||50;f.settings.assetFolder=f.settings.assetFolder||"/assets/";f.settings.textureFolder=f.settings.textureFolder||"/artwork/";f.settings.smallTextureFolder=f.settings.smallTextureFolder||null;f.settings.autoInit=f.settings.autoInit||!0;f.settings.idAsTexture=f.settings.idAsTexture||!1;f.settings.misingImg=f.settings.misingImg||null;f.settings.sets="BRM GVG LOE NAX TGT OG".split(" ").concat(f.settings.customSets);
f.settings.debug=f.settings.debug||!1;f.init=function(){"string"===typeof f.settings.misingImg&&N(["u:"+f.settings.misingImg]);P=!0;A.length&&L()};f.settings.autoInit||f.init();f.races={enUS:{MURLOC:"Murloc",MECHANICAL:"Mech",BEAST:"Beast",DEMON:"Demon",PIRATE:"Pirate",DRAGON:"Dragon",TOTEM:"Totem"},deDE:{MURLOC:"Murloc",MECHANICAL:"Mech",BEAST:"Wildtier",DEMON:"D\u00e4mon",PIRATE:"Pirat",DRAGON:"Drache",TOTEM:"Totem"}};f.clearCache=function(){u={}};f.createCard=function(b,c,d){if(!b)throw Error("No card object given");
d||(d=new Image);-1===V.indexOf(b.rarity)&&(b.rarity="FREE");void 0===b.title&&(b.title=b.name);void 0===b.gameId&&(b.gameId=b.id);f.settings.idAsTexture&&(b.texture=b.gameId);b.costStyle=b.costStyle||"0";b.healthStyle=b.healthStyle||"0";b.attackStyle=b.attackStyle||"0";b.durabilityStyle=b.durabilityStyle||"0";b.silenced=b.silenced||!1;b.width=c;var a=G(b);if(u[a]&&!f.settings.debug)d.src=u[a];else return r("Queried render: "+b.title),K(b,c,function(b){d.src=u[a]=b.toDataURL()}),{target:d,redraw:function(){a=
G(b);delete u[a];K(b,c,function(b){d.src=u[a]=b.toDataURL()})},update:function(f){for(var e in f)b[e]=f[e];a=G(b);u[a]?d.src=u[a]:K(b,c,function(b){d.src=u[a]=b.toDataURL()})}}}})();