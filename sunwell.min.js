/**
 * Sunwell
 * =======
 * Sunwell is a renderer for hearthstone cards.
 *
 * @author Christian Engel <hello@wearekiss.com>
 */
(function(){function r(b){g.settings.debug&&console.log(b)}function C(b,c,d){var a;if(t.length){if(b)for(var f=0;f<t.length;f++){if(t[f].width===b&&t[f].height===c){a=t.splice(f,1)[0];break}}else a=t.pop();if(a)return d&&a.getContext("2d").clearRect(0,0,a.width,a.height),a}a=document.createElement("canvas");b&&(a.width=b,a.height=c);return a}function F(b){r("Substitute for "+b);if(B)return B;b=C();var c=b.getContext("2d");b.width=b.height=512;c.save();c.fillStyle="grey";c.fillRect(0,0,512,512);c.fill();
c.fillStyle="red";c.textAlign="center";c.textBaseline="middle";c.font="50px Belwe";c.fillText("missing artwork",256,256);c.restore();B=new Image;B.src=b.toDataURL();return B}function n(b){return m[b]||F(b)}function K(b){var c,d=305419896;c=""+b.gameId;c+=b.playerClass;c+=b.race;c+=b.rarity;c+=b.set;c+=b.silenced;c+=b.costHealth;c+=b.texture;c+=b.type;c+=b.width;for(b=0;b<c.length;b++)d+=c.charCodeAt(b)*(b+1);return d}function L(b,c,d,a,f){var e=a/2*.5522848,q=f/2*.5522848,h=c+a,g=d+f;a=c+a/2;f=d+
f/2;b.beginPath();b.moveTo(c,f);b.bezierCurveTo(c,f-q,a-e,d,a,d);b.bezierCurveTo(a+e,d,h,f-q,h,f);b.bezierCurveTo(h,f+q,a+e,g,a,g);b.bezierCurveTo(a-e,g,c,f+q,c,f);b.stroke()}function P(b){return new Promise(function(c){for(var d=0,a=1,f={},e,q,h,l,k=0;k<b.length;k++)e=b[k],h=q=!1,"h:"===e.substr(0,2)&&(q=!0,h=!!g.settings.smallTextureFolder,e=e.substr(2)),"t:"===e.substr(0,2)&&(q=!0,e=e.substr(2),void 0!==m[e]&&256===m[e].width&&(m[e]=void 0)),"u:"===e.substr(0,2)&&(l=!0,e=e.substr(2)),void 0===
m[e]?(m[e]=new Image,m[e].crossOrigin="Anonymous",m[e].loaded=!1,a++,function(b){m[b].addEventListener("load",function(){d++;m[b].loaded=!0;f[b]=m[b];m[b].width&&m[b].height||(m[b].src=F().src);d>=a&&c(f)});m[b].addEventListener("error",function(){d++;m[b].src=F().src;m[b].loaded=!0;f[b]=m[b];d>=a&&c(f)})}(e),l?m[e].src=e:(q?(m[e].isTexture=!0,q=h?g.settings.smallTextureFolder+e+".jpg":g.settings.textureFolder+e+".jpg"):q=g.settings.assetFolder+e+".png",r("Requesting "+q),m[e].src=q)):(a++,m[e].loaded?
(d++,f[e]=m[e]):function(b){m[b].addEventListener("load",function(){d++;f[b]=m[b];d>=a&&c(f)})}(e));a--;0<d&&d>=a&&c(f)})}function G(b){var c=b.canvas.width,d=b.canvas.height;b=b.getImageData(0,0,c,d).data;var a,f,e=999,g=999,h=0,l=0,k=!1;for(f=d-1;-1<f&&!k;f--)for(a=0;a<c;a++)if(0<b[4*f*c+4*a+3]){l=Math.max(l,f);k=!0;break}if(void 0===l)return null;a=c-1;a:for(;-1<a;a--)for(f=0;f<d;f++)if(0<b[4*f*c+4*a+3]){h=Math.max(h,a);break a}a=0;a:for(;a<h;a++)for(f=0;f<d;f++)if(0<b[4*f*c+4*a+3]){e=Math.min(a,
e);break a}f=0;a:for(;f<l;f++)for(a=0;a<c;a++)if(0<b[4*f*c+4*a+3]){g=Math.min(g,f);break a}return{x:e,y:g,maxX:h,maxY:l,w:h-e,h:l-g}}function Q(b,c,d){var a,f;a=g.races[d.language]?g.races[d.language][d.race]?g.races[d.language][d.race]:d.race:g.races.enUS[d.race]?g.races.enUS[d.race]:d.race;d=C();var e=d.getContext("2d");d.width=300;d.height=60;e.font="45px Belwe";e.lineCap="round";e.lineJoin="round";e.textBaseline="hanging";e.textAlign="left";a=a.split("");f=10;for(var q=0;q<a.length;q++)e.lineWidth=
8,e.strokeStyle="black",e.fillStyle="black",e.fillText(a[q],f,10),e.strokeText(a[q],f,10),e.fillStyle="white",e.strokeStyle="white",e.lineWidth=1,e.fillText(a[q],f,10),f+=e.measureText(a[q]).width;a=G(e);b.drawImage(d,a.x,a.y,a.w,a.h,(394-a.w/2)*c,(1001-a.h/2)*c,a.w*c,a.h*c);t.push(d)}function x(b,c,d,a,f,e,g){var h=C(),l=h.getContext("2d");void 0===g&&(g="0");h.width=256;h.height=256;f=f.toString();f=f.split("");var k=10;l.font=e+"px Belwe";l.lineCap="round";l.lineJoin="round";l.textBaseline="hanging";
l.textAlign="left";e="white";"-"===g&&(e="#f00");"+"===g&&(e="#0f0");for(g=0;g<f.length;g++)l.lineWidth=13,l.strokeStyle="black",l.fillStyle="black",l.fillText(f[g],k,10),l.strokeText(f[g],k,10),l.fillStyle=e,l.strokeStyle=e,l.lineWidth=2.5,l.fillText(f[g],k,10),k+=l.measureText(f[g]).width;f=G(l);b.drawImage(h,f.x,f.y,f.w,f.h,(c-f.w/2)*a,(d-f.h/2)*a,f.w*a,f.h*a);t.push(h)}function H(b,c,d,a,f,e){g.settings.debug&&(b.save(),b.strokeStyle="red",b.beginPath(),b.moveTo(e/2-a/2,f),b.lineTo(e/2+a/2,f),
b.stroke(),b.restore());e=e/2-a/2;0>e&&(e=0);0<a&&0<c.width&&b.drawImage(c,0,0,a>c.width?c.width:a,c.height,e,f,Math.min(a,c.width),c.height);a=5;f+=c.height;d.clearRect(0,0,c.width,c.height);return[a,f]}function M(b,c,d,a){var f="[x]"===d.text.substr(0,3),e=C(),q=e.getContext("2d"),h=C(),l=h.getContext("2d"),k=f?d.text.substr(3):d.text,m,p,n,v,u=0,w=0,A=0,B=0,D,x,z=0,y;for(y=k;null!==(m=R.exec(k));)y=y.replace(m[0],m[1]+m[2]+(1===parseInt(m[1],10)?m[3]:m[4]));k=y;m=k.replace(/[\$#_]/g,"").split(/( |\n)/g);
r("Rendering body: "+k);e.width=520;e.height=290;h.width=520;"SPELL"===d.type&&(e.width=460,e.height=290,h.width=460);"WEAPON"===d.type&&(e.width=470,e.height=250,h.width=470);k=g.settings.bodyFontSize;n=g.settings.bodyLineHeight;D=d.text.replace(/<\/*.>/g,"").length;y=!1;80<=D&&(k=.9*g.settings.bodyFontSize,n=.9*g.settings.bodyLineHeight);100<=D&&(k=.8*g.settings.bodyFontSize,n=.8*g.settings.bodyLineHeight);h.height=n;75<=D&&"SPELL"===d.type&&(y=!0);a&&(y=!0);l.fillStyle="WEAPON"===d.type?"#fff":
"#000";l.textBaseline="hanging";l.font=k+'px/1em "'+g.settings.bodyFont+'", sans-serif';for(D=0;D<m.length;D++){p=m[D];n=p.split("");v=l.measureText(p).width;r("Next word: "+p);!f&&(u+v>h.width||y&&u+v>.8*h.width)&&(r(u+v+" > "+h.width),r("Calculated line break"),y=!1,z++,w=H(q,h,l,u,w,e.width),u=w[0],w=w[1],x=!0);for(p=0;p<n.length;p++)v=n[p],r(v+" "+v.charCodeAt(0)),10===v.charCodeAt(0)?x?x=!1:(z++,w=H(q,h,l,u,w,e.width),u=w[0],w=w[1],r("Manual line break")):(x=!1,"<"===v?("/"===n[p+1]?("b"===n[p+
2]&&(A--,p+=3),"i"===n[p+2]&&(B--,p+=3)):("b"===n[p+1]&&(A++,p+=2),"i"===n[p+1]&&(B++,p+=2)),l.font=(0<A?"bold ":"")+(0<B?"italic":"")+" "+k+'px/1em "'+g.settings.bodyFont+'", sans-serif'):(l.fillText(v,u+g.settings.bodyFontOffset.x,g.settings.bodyFontOffset.y),u+=l.measureText(v).width+.375));u+=3}z++;H(q,h,l,u,w,e.width);t.push(h);"SPELL"!==d.type||4!==z||y||a?(d=G(q),d.h=Math.ceil(d.h/h.height)*h.height,b.drawImage(e,d.x,d.y-2,d.w,d.h,(390-d.w/2)*c,(860-d.h/2)*c,d.w*c,(d.h+2)*c),t.push(e),g.settings.debug&&
(b.save(),b.strokeStyle="green",b.beginPath(),b.rect((390-d.w/2)*c,(860-d.h/2)*c,d.w*c,(d.h+2)*c),b.stroke(),b.strokeStyle="red",b.beginPath(),b.rect((390-e.width/2)*c,(860-e.height/2)*c,e.width*c,(e.height+2)*c),b.stroke(),b.restore())):M(b,c,d,!0)}function I(b,c){return{x:Math.pow(1-c,3)*b[0].x+3*Math.pow(1-c,2)*c*b[1].x+3*(1-c)*Math.pow(c,2)*b[2].x+Math.pow(c,3)*b[3].x,y:Math.pow(1-c,3)*b[0].y+3*Math.pow(1-c,2)*c*b[1].y+3*(1-c)*Math.pow(c,2)*b[2].y+Math.pow(c,3)*b[3].y,r:Math.atan2(3*Math.pow(1-
c,2)*(b[1].y-b[0].y)+6*(1-c)*c*(b[2].y-b[1].y)+3*Math.pow(c,2)*(b[3].y-b[2].y),3*Math.pow(1-c,2)*(b[1].x-b[0].x)+6*(1-c)*c*(b[2].x-b[1].x)+3*Math.pow(c,2)*(b[3].x-b[2].x))}}function S(b,c,d){var a=C(),f=d.title;a.width=1024;a.height=200;var e=a.getContext("2d");e.save();var q=.58,h=580,l=[{x:0,y:110},{x:102,y:137},{x:368,y:16},{x:580,y:100}];"SPELL"===d.type&&(q=.52,h=580,l=[{x:10,y:100},{x:212,y:35},{x:368,y:35},{x:570,y:105}]);"WEAPON"===d.type&&(q=.58,h=580,l=[{x:10,y:75},{x:50,y:75},{x:500,y:75},
{x:570,y:75}]);d=51;e.lineWidth=13;e.strokeStyle="black";e.lineCap="round";e.lineJoin="round";e.textAlign="left";e.textBaseline="middle";for(var k=h+1;k>h&&10<d;){--d;e.font=d+"px Belwe";for(var m=k=0;m<f.length;m++)k+=e.measureText(f[m]).width+2;k*=1.25}k/=h;q-=k/2;h=k/f.length;g.settings.debug&&(e.save(),e.strokeStyle="red",e.lineWidth=5,e.beginPath(),e.moveTo(l[0].x,l[0].y),e.bezierCurveTo(l[1].x,l[1].y,l[2].x,l[2].y,l[3].x,l[3].y),e.stroke(),e.restore());for(var p,n,m=k=0;m<f.length;m++){if(0===
k)n=q+h*m,p=I(l,n),k=p.x;else for(n+=.01,p=I(l,n);p.x<k;)n+=.001,p=I(l,n);e.save();e.translate(p.x,p.y);e.scale(1.2,1);e.rotate(p.r);e.lineWidth=d/50*10;e.strokeStyle="black";e.fillStyle="black";e.fillText(f[m],0,0);e.strokeText(f[m],0,0);p=1.25*e.measureText(f[m]).width;k+=p;-1!==["i","f"].indexOf(f[m])&&(k+=.1*p);e.fillStyle="white";e.strokeStyle="white";e.lineWidth=d/50*2.5;e.fillText(f[m],0,0);e.restore()}b.drawImage(a,0,0,580,200,105*c,525*c,580*c,200*c);t.push(a)}function N(b,c,d,a,f,e){var g=
d.sunwell,h,l,k=0,m=Date.now();l=setTimeout(function(){r("Drawing timeout at point "+k+" in "+d.title);r(d);e()},5E3);"string"===typeof d.texture?h=n(d.texture):d.texture instanceof Image?h=d.texture:(h=C(),h.width=d.texture.crop.w,h.height=d.texture.crop.h,h.getContext("2d").drawImage(d.texture.image,d.texture.crop.x,d.texture.crop.y,d.texture.crop.w,d.texture.crop.h,0,0,h.width,h.height));h||(h=n("~"));k=2;c.save();c.clearRect(0,0,b.width,b.height);z[d._cacheKey]?(r("Skipping skeleton draw"),c.drawImage(z[d._cacheKey],
0,0)):(k=3,c.save(),"MINION"===d.type&&(L(c,180*a,75*a,430*a,590*a),c.clip(),c.fillStyle="grey",c.fillRect(0,0,765*a,1100*a),c.drawImage(h,0,0,h.width,h.height,100*a,75*a,590*a,590*a)),"SPELL"===d.type&&(c.rect(125*a,165*a,529*a,434*a),c.clip(),c.fillStyle="grey",c.fillRect(0,0,765*a,1100*a),c.drawImage(h,0,0,h.width,h.height,125*a,117*a,529*a,529*a)),"WEAPON"===d.type&&(L(c,150*a,135*a,476*a,468*a),c.clip(),c.fillStyle="grey",c.fillRect(0,0,765*a,1100*a),c.drawImage(h,0,0,h.width,h.height,150*a,
135*a,476*a,476*a)),c.restore(),k=4,c.drawImage(n(g.cardBack),0,0,764,1100,0,0,b.width,b.height),k=5,d.costHealth?(c.drawImage(n("health"),0,0,167,218,24*a,62*a,167*a,218*a),c.save(),c.shadowBlur=50*a,c.shadowColor="#FF7275",c.shadowOffsetX=1E3,c.globalAlpha=.5,c.drawImage(n("health"),0,0,167,218,24*a-1E3,62*a,167*a,218*a),c.restore()):c.drawImage(n("gem"),0,0,182,180,24*a,82*a,182*a,180*a),k=6,"MINION"===d.type&&(g.rarity&&c.drawImage(n(g.rarity),0,0,146,146,326*a,607*a,146*a,146*a),c.drawImage(n("title"),
0,0,608,144,94*a,546*a,608*a,144*a),d.race&&c.drawImage(n("race"),0,0,529,106,125*a,937*a,529*a,106*a),c.drawImage(n("attack"),0,0,214,238,0,862*a,214*a,238*a),c.drawImage(n("health"),0,0,167,218,575*a,876*a,167*a,218*a),"LEGENDARY"===d.rarity&&c.drawImage(n("dragon"),0,0,569,417,196*a,0,569*a,417*a)),k=7,"SPELL"===d.type&&(g.rarity&&c.drawImage(n(g.rarity),0,0,149,149,311*a,607*a,150*a,150*a),c.drawImage(n("title-spell"),0,0,646,199,66*a,530*a,646*a,199*a)),"WEAPON"===d.type&&(g.rarity&&c.drawImage(n(g.rarity),
0,0,146,144,315*a,592*a,146*a,144*a),c.drawImage(n("title-weapon"),0,0,660,140,56*a,551*a,660*a,140*a),c.drawImage(n("swords"),0,0,312,306,32*a,906*a,187*a,183*a),c.drawImage(n("shield"),0,0,301,333,584*a,890*a,186*a,205*a)),k=8,"CORE"!==d.set&&(d.race&&"MINION"===d.type?c.drawImage(n(g.bgLogo),0,0,281,244,256*a,734*a,266.95*a,244*.95*a):"SPELL"===d.type?c.drawImage(n(g.bgLogo),0,0,281,244,256*a,740*a,253*a,220*a):(c.globalAlpha=.6,c.drawImage(n(g.bgLogo),0,0,259,209,256*a,750*a,259*a,209*a),c.globalAlpha=
1)),k=9,function(){var a=new Image;a.src=b.toDataURL();z[d._cacheKey]=a}());k=10;x(c,116,170,a,d.cost||0,170,d.costStyle);k=11;S(c,a,d);k=12;"MINION"===d.type&&(d.race&&Q(c,a,d),x(c,128,994,a,d.attack||0,150,d.attackStyle),x(c,668,994,a,d.health||0,150,d.healthStyle));k=13;"WEAPON"===d.type&&(x(c,128,994,a,d.attack||0,150,d.attackStyle),x(c,668,994,a,d.durability||0,150,d.durabilityStyle));k=14;d.silenced&&"MINION"===d.type?c.drawImage(n("silence-x"),0,0,410,397,200*a,660*a,410*a,397*a):M(c,a,d);
c.restore();clearTimeout(l);r("Rendertime: "+(Date.now()-m)+"ms");e();f.target.src=b.toDataURL()}function T(b){E.push([b,this]);A||J()}function J(){O&&(U(),window.requestAnimationFrame(J))}function U(){if(!(12<A)){var b,c,d;if(E.length){var a=E.shift();A++;b=a[0];c=b.width;d=a[1];var f=C(c,Math.round(1.4397905759*c),!0),e=f.getContext("2d"),g=c/764,a=["silence-x","health"];b._assetsLoaded===c?N(f,e,b,g,d,function(){A--;r("Card rendered: "+b.title);t.push(f)}):(r("Preparing assets for: "+b.title),
b.sunwell=b.sunwell||{},b.sunwell.cardBack=b.type.substr(0,1).toLowerCase()+b.playerClass.substr(0,1)+b.playerClass.substr(1).toLowerCase(),a.push(b.sunwell.cardBack),a.push("gem"),"MINION"===b.type&&(a.push("attack","title"),"LEGENDARY"===b.rarity&&a.push("dragon"),"FREE"===b.rarity||"COMMON"===b.rarity&&"CORE"===b.set||(b.sunwell.rarity="rarity-"+b.rarity.toLowerCase(),a.push(b.sunwell.rarity))),"SPELL"===b.type&&(a.push("attack","title-spell"),"FREE"===b.rarity||"COMMON"===b.rarity&&"CORE"===b.set||
(b.sunwell.rarity="spell-rarity-"+b.rarity.toLowerCase(),a.push(b.sunwell.rarity))),"WEAPON"===b.type&&(a.push("swords","shield","title-weapon"),"FREE"===b.rarity||"COMMON"===b.rarity&&"CORE"===b.set||(b.sunwell.rarity="weapon-rarity-"+b.rarity.toLowerCase(),a.push(b.sunwell.rarity))),-1==="BRM GVG LOE NAX TGT OG".split(" ").indexOf(b.set)?b.sunwell.bgLogo="bg-cl":b.sunwell.bgLogo="bg-"+b.set.toLowerCase(),"SPELL"===b.type&&(b.sunwell.bgLogo="spell-"+b.sunwell.bgLogo),"WEAPON"===b.type&&(b.sunwell.bgLogo=
"w-"+b.sunwell.bgLogo),a.push(b.sunwell.bgLogo),b.race&&a.push("race"),"string"===typeof b.texture&&"CHEAT"!==b.set&&(.5>=g?a.push("h:"+b.texture):a.push("t:"+b.texture)),r("Assets prepared, now loading"),P(a).then(function(){r("Assets loaded for: "+b.title);b._assetsLoaded=c;N(f,e,b,g,d,function(){A--;r("Card rendered: "+b.title);t.push(f)})}))}}}var g,m={},O=!1,E=[],A=0,z={},t=[],R=/(\d+)(.+?)\|4\((.+?),(.+?)\)/g,V=["COMMON","RARE","EPIC","LEGENDARY"],B;window.sunwell=g=window.sunwell||{};g._buffers=
t;g._renderQuery=E;g._activeRenders=A;g.settings=g.settings||{};g.settings.titleFont=g.settings.titleFont||"Belwe Bold";g.settings.bodyFont=g.settings.bodyFont||"ITC Franklin Condensed";g.settings.bodyFontSize=g.settings.bodyFontSize||60;g.settings.bodyFontOffset=g.settings.bodyFontOffset||{x:0,y:0};g.settings.bodyLineHeight=g.settings.bodyLineHeight||50;g.settings.assetFolder=g.settings.assetFolder||"/assets/";g.settings.textureFolder=g.settings.textureFolder||"/artwork/";g.settings.smallTextureFolder=
g.settings.smallTextureFolder||null;g.settings.autoInit=g.settings.autoInit||!0;g.settings.idAsTexture=g.settings.idAsTexture||!1;g.settings.debug=g.settings.debug||!1;g.init=function(){O=!0;E.length&&J()};g.settings.autoInit||g.init();g.races={enUS:{MURLOC:"Murloc",MECHANICAL:"Mech",BEAST:"Beast",DEMON:"Demon",PIRATE:"Pirate",DRAGON:"Dragon",TOTEM:"Totem"},deDE:{MURLOC:"Murloc",MECHANICAL:"Mech",BEAST:"Wildtier",DEMON:"D\u00e4mon",PIRATE:"Pirat",DRAGON:"Drache",TOTEM:"Totem"}};g.clearCache=function(){z=
{}};g.Card=function(b,c,d){if(!b)throw Error("No card properties given");d||(d=new Image);this.target=d;-1===V.indexOf(b.rarity)&&(b.rarity="FREE");void 0===b.title&&(b.title=b.name);void 0===b.gameId&&(b.gameId=b.id);g.settings.idAsTexture&&(b.texture=b.gameId);b.costStyle=b.costStyle||"0";b.healthStyle=b.healthStyle||"0";b.attackStyle=b.attackStyle||"0";b.durabilityStyle=b.durabilityStyle||"0";b.silenced=b.silenced||!1;b.costHealth=b.costHealth||!1;b.width=c;b._cacheKey=K(b);this._props=b;r("Queried render: "+
b.title);this._render=T.bind(this);this._render(this._props)};g.Card.prototype={target:null,_render:null,_props:null,redraw:function(){delete z[this._props._cacheKey];this._render(this._props)},update:function(b){for(var c in b)this._props[c]=b[c];this._props._cacheKey=K(this._props);this._render(this._props)}};g.createCard=function(b,c,d){return new g.Card(b,c,d)}})();