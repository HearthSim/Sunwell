/**
 * Sunwell
 * =======
 * Sunwell is a renderer for hearthstone cards.
 *
 * @author Christian Engel <hello@wearekiss.com>
 */
(function(){function z(){return A.length?A.pop():document.createElement("canvas")}function H(){if(I)return I;var a=z(),e=a.getContext("2d");a.width=a.height=512;e.save();e.fillStyle="grey";e.fillRect(0,0,512,512);e.fill();e.fillStyle="red";e.textAlign="center";e.textBaseline="middle";e.font="50px Belwe";e.fillText("missing artwork",256,256);e.restore();return I=a.toDataURL()}function O(a,e,k,c,g){var d=c/2*.5522848,b=g/2*.5522848,f=e+c,q=k+g;c=e+c/2;g=k+g/2;a.beginPath();a.moveTo(e,g);a.bezierCurveTo(e,
g-b,c-d,k,c,k);a.bezierCurveTo(c+d,k,f,g-b,f,g);a.bezierCurveTo(f,g+b,c+d,q,c,q);a.bezierCurveTo(c-d,q,e,g+b,e,g);a.stroke()}function R(a){return new Promise(function(e){for(var w=0,c=1,g={},d,b,f,q,J=0;J<a.length;J++)d=a[J],f=b=!1,"h:"===d.substr(0,2)&&(b=!0,f=!!k.settings.smallTextureFolder,d=d.substr(2)),"t:"===d.substr(0,2)&&(b=!0,d=d.substr(2),void 0!==h[d]&&256===h[d].width&&(h[d]=void 0)),"u:"===d.substr(0,2)&&(q=!0,d=d.substr(2)),void 0===h[d]?(h[d]=new Image,h[d].crossOrigin="Anonymous",
h[d].loaded=!1,c++,function(a){h[a].addEventListener("load",function(){w++;h[a].loaded=!0;g[a]=h[a];h[a].width&&h[a].height||(h[a].src=H());w>=c&&e(g)});h[a].addEventListener("error",function(){w++;h[a].src=H();h[a].loaded=!0;g[a]=h[a];w>=c&&e(g)})}(d),q?h[d].src=d:b?(h[d].isTexture=!0,h[d].src=f?k.settings.smallTextureFolder+d+".jpg":k.settings.textureFolder+d+".jpg"):h[d].src=k.settings.assetFolder+d+".png"):(c++,h[d].loaded?(w++,g[d]=h[d]):function(a){h[a].addEventListener("load",function(){w++;
g[a]=h[a];w>=c&&e(g)})}(d));c--;0<w&&w>=c&&e(g)})}function K(a){var e=a.canvas.width,k=a.canvas.height;a=a.getImageData(0,0,e,k).data;var c,g,d=999,b=999,f=0,q=0,h=!1;for(g=k-1;-1<g&&!h;g--)for(c=0;c<e;c++)if(0<a[4*g*e+4*c+3]){q=Math.max(q,g);h=!0;break}if(void 0===q)return null;c=e-1;a:for(;-1<c;c--)for(g=0;g<k;g++)if(0<a[4*g*e+4*c+3]){f=Math.max(f,c);break a}c=0;a:for(;c<f;c++)for(g=0;g<k;g++)if(0<a[4*g*e+4*c+3]){d=Math.min(c,d);break a}g=0;a:for(;g<q;g++)for(c=0;c<e;c++)if(0<a[4*g*e+4*c+3]){b=
Math.min(b,g);break a}return{x:d,y:b,maxX:f,maxY:q,w:f-d,h:q-b}}function F(a,e,k,c,g,d,b,f){var q=z(),h=q.getContext("2d");void 0===b&&(b=g);q.width=256;q.height=256;g=g.toString();g=g.split("");var m=10;h.font=d+"px Belwe";h.lineCap="round";h.lineJoin="round";h.textBaseline="hanging";h.textAlign="left";d="white";f?(g>b&&(d="#f00"),g<b&&(d="#0f0")):(g<b&&(d="#f00"),g>b&&(d="#0f0"));for(b=0;b<g.length;b++)h.lineWidth=13,h.strokeStyle="black",h.fillStyle="black",h.fillText(g[b],m,10),h.strokeText(g[b],
m,10),h.fillStyle=d,h.strokeStyle=d,h.lineWidth=2.5,h.fillText(g[b],m,10),m+=h.measureText(g[b]).width;g=K(h);a.drawImage(q,g.x,g.y,g.w,g.h,(e-g.w/2)*c,(k-g.h/2)*c,g.w*c,g.h*c);A.push(q)}function P(a,e,h,c,g,d){k.settings.debug&&(a.save(),a.strokeStyle="red",a.beginPath(),a.moveTo(d/2-c/2,g),a.lineTo(d/2+c/2,g),a.stroke(),a.restore());d=d/2-c/2;0>d&&(d=0);0<c&&0<e.width&&a.drawImage(e,0,0,c>e.width?e.width:c,e.height,d,g,Math.min(c,e.width),e.height);c=5;g+=e.height;h.clearRect(0,0,e.width,e.height);
return[c,g]}function L(a,e){return{x:Math.pow(1-e,3)*a[0].x+3*Math.pow(1-e,2)*e*a[1].x+3*(1-e)*Math.pow(e,2)*a[2].x+Math.pow(e,3)*a[3].x,y:Math.pow(1-e,3)*a[0].y+3*Math.pow(1-e,2)*e*a[1].y+3*(1-e)*Math.pow(e,2)*a[2].y+Math.pow(e,3)*a[3].y,r:Math.atan2(3*Math.pow(1-e,2)*(a[1].y-a[0].y)+6*(1-e)*e*(a[2].y-a[1].y)+3*Math.pow(e,2)*(a[3].y-a[2].y),3*Math.pow(1-e,2)*(a[1].x-a[0].x)+6*(1-e)*e*(a[2].x-a[1].x)+3*Math.pow(e,2)*(a[3].x-a[2].x))}}function M(a,e,k){y.push([a,e,k]);G||N()}function N(){Q&&(S(),window.requestAnimationFrame(N))}
function S(){if(!(8<G)){var a,e,w;if(y.length){var c=y.shift();G++;a=c[0];e=c[1];w=c[2];var g=z(),d=g.getContext("2d"),b=(e||512)/764,c=[];g.width=e||512;g.height=Math.round(1.4397905759*g.width);a.sunwell=a.sunwell||{};a.sunwell.cardBack=a.type.substr(0,1).toLowerCase()+a.playerClass.substr(0,1)+a.playerClass.substr(1).toLowerCase();c.push(a.sunwell.cardBack);c.push("gem");"MINION"===a.type&&(c.push("attack","health","title"),"LEGENDARY"===a.rarity&&c.push("dragon"),"FREE"===a.rarity||"COMMON"===
a.rarity&&"CORE"===a.set||(a.sunwell.rarity="rarity-"+a.rarity.toLowerCase(),c.push(a.sunwell.rarity)));"SPELL"===a.type&&(c.push("attack","health","title-spell"),"FREE"===a.rarity||"COMMON"===a.rarity&&"CORE"===a.set||(a.sunwell.rarity="spell-rarity-"+a.rarity.toLowerCase(),c.push(a.sunwell.rarity)));"WEAPON"===a.type&&(c.push("swords","shield","title-weapon"),"FREE"===a.rarity||"COMMON"===a.rarity&&"CORE"===a.set||(a.sunwell.rarity="weapon-rarity-"+a.rarity.toLowerCase(),c.push(a.sunwell.rarity)));
-1==="BRM GVG LOE NAX TGT WOG".split(" ").indexOf(a.set)?a.sunwell.bgLogo="bg-cl":a.sunwell.bgLogo="bg-"+a.set.toLowerCase();"SPELL"===a.type&&(a.sunwell.bgLogo="spell-"+a.sunwell.bgLogo);c.push(a.sunwell.bgLogo);a.race&&c.push("race");"string"===typeof a.texture&&"CHEAT"!==a.set&&(.5>=b?c.push("h:"+a.texture):c.push("t:"+a.texture));R(c).then(function(){var f=a.sunwell,c;"string"===typeof a.texture?c=h[a.texture]:a.texture instanceof Image?c=a.texture:(c=z(),c.width=a.texture.crop.w,c.height=a.texture.crop.h,
c.getContext("2d").drawImage(a.texture.image,a.texture.crop.x,a.texture.crop.y,a.texture.crop.w,a.texture.crop.h,0,0,c.width,c.height));c||(c=h.empty);d.save();d.clearRect(0,0,g.width,g.height);d.save();"MINION"===a.type&&(O(d,180*b,75*b,430*b,590*b),d.clip(),d.drawImage(c,0,0,c.width,c.height,100*b,75*b,590*b,590*b));"SPELL"===a.type&&(d.rect(125*b,165*b,529*b,434*b),d.clip(),d.drawImage(c,0,0,c.width,c.height,125*b,117*b,529*b,529*b));"WEAPON"===a.type&&(O(d,150*b,135*b,476*b,468*b),d.clip(),d.drawImage(c,
0,0,c.width,c.height,150*b,135*b,476*b,476*b));d.restore();d.drawImage(h[f.cardBack],0,0,764,1100,0,0,g.width,g.height);d.drawImage(h.gem,0,0,182,180,24*b,82*b,182*b,180*b);"MINION"===a.type&&(f.rarity&&d.drawImage(h[f.rarity],0,0,146,146,326*b,607*b,146*b,146*b),d.drawImage(h.title,0,0,608,144,94*b,546*b,608*b,144*b),a.race&&d.drawImage(h.race,0,0,529,106,125*b,937*b,529*b,106*b),d.drawImage(h.attack,0,0,214,238,0,862*b,214*b,238*b),d.drawImage(h.health,0,0,167,218,575*b,876*b,167*b,218*b),"LEGENDARY"===
a.rarity&&d.drawImage(h.dragon,0,0,569,417,196*b,0,569*b,417*b));"SPELL"===a.type&&(f.rarity&&d.drawImage(h[f.rarity],0,0,150,150,311*b,607*b,150*b,150*b),d.drawImage(h["title-spell"],0,0,646,199,66*b,530*b,646*b,199*b));"WEAPON"===a.type&&(f.rarity&&d.drawImage(h[f.rarity],0,0,146,144,315*b,592*b,146*b,144*b),d.drawImage(h["title-weapon"],0,0,660,140,56*b,551*b,660*b,140*b),d.drawImage(h.swords,0,0,312,306,32*b,906*b,187*b,183*b),d.drawImage(h.shield,0,0,301,333,584*b,890*b,186*b,205*b));if("CORE"!==
a.set){var e;"SPELL"===a.type&&(e=265);"MINION"===a.type&&(e=265);a.race&&"MINION"===a.type?d.drawImage(h[f.bgLogo],0,0,281,244,e*b,734*b,266.95*b,244*.95*b):"SPELL"===a.type?d.drawImage(h[f.bgLogo],0,0,281,244,e*b,740*b,253*b,220*b):d.drawImage(h[f.bgLogo],0,0,281,244,e*b,734*b,281*b,244*b)}f=z();e=f.getContext("2d");c=z();var m=c.getContext("2d"),t=a.textMarkdown.replace(/[\$#_]/g,"").split(" "),x,B,D,n=0,E=0,l,r,y,C;f.width=520;f.height=290;c.width=520;"SPELL"===a.type&&(f.width=460,f.height=290,
c.width=460);"WEAPON"===a.type&&(f.width=470,f.height=250,c.width=470);var p=k.settings.bodyFontSize;B=k.settings.bodyLineHeight;D=a.textMarkdown.replace(/\*\*/g,"").length;var u=!1;100<=D&&(p=.8*k.settings.bodyFontSize,B=.8*k.settings.bodyLineHeight);c.height=B;75<=D&&"SPELL"===a.type&&(u=!0);m.fillStyle="WEAPON"===a.type?"#fff":"#000";m.textBaseline="hanging";m.font=p+'px/1em "'+k.settings.bodyFont+'", sans-serif';D=m.measureText(" ").width;for(y=0;y<t.length;y++){x=t[y];B=x.split("");x=m.measureText(x).width;
if(n+x>c.width-10||u&&n+x>.8*c.width)u=!1,E=P(e,c,m,n,E,f.width),n=E[0],E=E[1];for(C=0;C<B.length;C++)x=B[C],"*"===x?"*"===B[C+1]?(l?(l=!1,m.font=" "+p+'px/1em "'+k.settings.bodyFont+'", sans-serif'):(l=!0,m.font="bold "+p+'px/1em "'+k.settings.bodyFont+'", sans-serif'),C+=1):r?(r=!1,m.font=" "+p+'px/1em "'+k.settings.bodyFont+'", sans-serif'):(r=!0,m.font="italic "+p+'px/1em "'+k.settings.bodyFont+'", sans-serif'):(m.fillText(x,n+k.settings.bodyFontOffset.x,k.settings.bodyFontOffset.y),n+=m.measureText(x).width+
D/8);n+=D}P(e,c,m,n,E,f.width);A.push(c);l=K(e);l.h=Math.ceil(l.h/c.height)*c.height;d.drawImage(f,l.x,l.y-2,l.w,l.h,(390-l.w/2)*b,(860-l.h/2)*b,l.w*b,(l.h+2)*b);A.push(f);k.settings.debug&&(d.save(),d.strokeStyle="green",d.beginPath(),d.rect((390-l.w/2)*b,(860-l.h/2)*b,l.w*b,(l.h+2)*b),d.stroke(),d.strokeStyle="red",d.beginPath(),d.rect((390-f.width/2)*b,(860-f.height/2)*b,f.width*b,(f.height+2)*b),d.stroke(),d.restore());F(d,116,170,b,a.cost||0,170,a._originalCost,!0);l=z();r=a.title;l.width=1024;
l.height=200;f=l.getContext("2d");f.save();t=.58;p=580;c=[{x:0,y:110},{x:102,y:137},{x:368,y:16},{x:580,y:100}];"SPELL"===a.type&&(t=.52,p=580,c=[{x:10,y:100},{x:212,y:35},{x:368,y:35},{x:570,y:105}]);"WEAPON"===a.type&&(t=.58,p=580,c=[{x:10,y:75},{x:50,y:75},{x:500,y:75},{x:570,y:75}]);e=51;f.lineWidth=13;f.strokeStyle="black";f.lineCap="round";f.lineJoin="round";f.textAlign="left";f.textBaseline="middle";for(n=p+1;n>p&&10<e;){--e;f.font=e+"px Belwe";for(m=n=0;m<r.length;m++)n+=f.measureText(r[m]).width+
2;n*=1.25}n/=p;t-=n/2;n/=r.length;k.settings.debug&&(f.save(),f.strokeStyle="red",f.lineWidth=5,f.beginPath(),f.moveTo(c[0].x,c[0].y),f.bezierCurveTo(c[1].x,c[1].y,c[2].x,c[2].y,c[3].x,c[3].y),f.stroke(),f.restore());for(var v,m=p=0;m<r.length;m++){if(0===p)v=t+n*m,u=L(c,v),p=u.x;else for(v+=.01,u=L(c,v);u.x<p;)v+=.001,u=L(c,v);f.save();f.translate(u.x,u.y);f.scale(1.2,1);f.rotate(u.r);f.lineWidth=e/50*10;f.strokeStyle="black";f.fillStyle="black";f.fillText(r[m],0,0);f.strokeText(r[m],0,0);u=1.25*
f.measureText(r[m]).width;p+=u;-1!==["i","f"].indexOf(r[m])&&(p+=.1*u);f.fillStyle="white";f.strokeStyle="white";f.lineWidth=e/50*2.5;f.fillText(r[m],0,0);f.restore()}d.drawImage(l,0,0,580,200,105*b,525*b,580*b,200*b);A.push(l);if("MINION"===a.type){if(a.race){l=k.races[a.language]?k.races[a.language][a.race]?k.races[a.language][a.race]:a.race:k.races.enUS[a.race]?k.races.enUS[a.race]:a.race;v=z();f=v.getContext("2d");v.width=300;v.height=60;f.font="45px Belwe";f.lineCap="round";f.lineJoin="round";
f.textBaseline="hanging";f.textAlign="left";l=l.split("");r=10;for(c=0;c<l.length;c++)f.lineWidth=8,f.strokeStyle="black",f.fillStyle="black",f.fillText(l[c],r,10),f.strokeText(l[c],r,10),f.fillStyle="white",f.strokeStyle="white",f.lineWidth=1,f.fillText(l[c],r,10),r+=f.measureText(l[c]).width;l=K(f);d.drawImage(v,l.x,l.y,l.w,l.h,(394-l.w/2)*b,(1001-l.h/2)*b,l.w*b,l.h*b);A.push(v)}F(d,128,994,b,a.attack||0,150,a._originalAttack);F(d,668,994,b,a.health||0,150,a._originalHealth)}"WEAPON"===a.type&&
(F(d,128,994,b,a.attack||0,150,a._originalAttack),F(d,668,994,b,a.durability||0,150,a._originalDurability));d.restore();w&&w(g);G--;A.push(g)})}}}var k,h={},Q=!1,y=[],G=0,t={},A=[],T=["COMMON","RARE","EPIC","LEGENDARY"],I;window.sunwell=k=window.sunwell||{};k.settings=k.settings||{};k.settings.titleFont=k.settings.titleFont||"Belwe Bold";k.settings.bodyFont=k.settings.bodyFont||"ITC Franklin Condensed";k.settings.bodyFontSize=k.settings.bodyFontSize||60;k.settings.bodyFontOffset=k.settings.bodyFontOffset||
{x:0,y:0};k.settings.bodyLineHeight=k.settings.bodyLineHeight||50;k.settings.assetFolder=k.settings.assetFolder||"/assets/";k.settings.textureFolder=k.settings.textureFolder||"/artwork/";k.settings.smallTextureFolder=k.settings.smallTextureFolder||null;k.settings.autoInit=k.settings.autoInit||!0;k.settings.idAsTexture=k.settings.idAsTexture||!1;k.settings.debug=k.settings.debug||!1;k.init=function(){Q=!0;y.length&&N()};k.settings.autoInit||k.init();k.races={enUS:{MURLOC:"Murloc",MECHANICAL:"Mech",
BEAST:"Beast",DEMON:"Demon",PIRATE:"Pirate",DRAGON:"Dragon",TOTEM:"Totem"},deDE:{MURLOC:"Murloc",MECHANICAL:"Mech",BEAST:"Wildtier",DEMON:"D\u00e4mon",PIRATE:"Pirat",DRAGON:"Drache",TOTEM:"Totem"}};h.empty=new Image;h.empty.src=H();k.clearCache=function(){t={}};k.createCard=function(a,e,h){if(!a)throw Error("No card object given");h||(h=new Image);-1===T.indexOf(a.rarity)&&(a.rarity="FREE");void 0===a.title&&(a.title=a.name);void 0===a.gameId&&(a.gameId=a.id);void 0===a.textMarkdown&&(a.textMarkdown=
a.text.replace(/<\/*b>/g,"**"));k.settings.idAsTexture&&(a.texture=a.gameId);var c=e+"_"+a.language+"_"+a.gameId+"_"+a.cost+"_"+a.attack+"_"+a.health;a._originalCost=a.cost;a._originalHealth=a.health;a._originalAttack=a.attack;a._originalDurability=a.durability;if(t[c])h.src=t[c];else return M(a,e,function(a){h.src=t[c]=a.toDataURL()}),{target:h,redraw:function(){c=e+"_"+a.language+"_"+a.gameId+"_"+a.cost+"_"+a.attack+"_"+a.health+"_"+a.health;delete t[c];M(a,e,function(a){h.src=t[c]=a.toDataURL()})},
update:function(g){for(var d in g)a[d]=g[d];c=e+"_"+a.language+"_"+a.gameId+"_"+a.cost+"_"+a.attack+"_"+a.health+"_"+a.health;t[c]?h.src=t[c]:M(a,e,function(a){h.src=t[c]=a.toDataURL()})}}}})();