/**
 * Sunwell
 * =======
 * Sunwell is a renderer for hearthstone cards.
 *
 * @author Christian Engel <hello@wearekiss.com>
 */
(function(){function p(b){g.settings.debug&&console.log(b)}function w(){return u.length?u.pop():document.createElement("canvas")}function C(){if(v)return v;var b=w(),c=b.getContext("2d");b.width=b.height=512;c.save();c.fillStyle="grey";c.fillRect(0,0,512,512);c.fill();c.fillStyle="red";c.textAlign="center";c.textBaseline="middle";c.font="50px Belwe";c.fillText("missing artwork",256,256);c.restore();v=new Image;v.src=b.toDataURL();return v}function n(b){return h[b]||C()}function D(b){var c,e="",a=
305419896;for(c in b)e=e+c+b[c];for(b=0;b<e.length;b++)a+=e.charCodeAt(b)*(b+1);return a}function I(b,c,e,a,f){var d=a/2*.5522848,m=f/2*.5522848,g=c+a,k=e+f;a=c+a/2;f=e+f/2;b.beginPath();b.moveTo(c,f);b.bezierCurveTo(c,f-m,a-d,e,a,e);b.bezierCurveTo(a+d,e,g,f-m,g,f);b.bezierCurveTo(g,f+m,a+d,k,a,k);b.bezierCurveTo(a-d,k,c,f+m,c,f);b.stroke()}function L(b){return new Promise(function(c){for(var e=0,a=1,f={},d,m,q,k,l=0;l<b.length;l++)d=b[l],q=m=!1,"h:"===d.substr(0,2)&&(m=!0,q=!!g.settings.smallTextureFolder,
d=d.substr(2)),"t:"===d.substr(0,2)&&(m=!0,d=d.substr(2),void 0!==h[d]&&256===h[d].width&&(h[d]=void 0)),"u:"===d.substr(0,2)&&(k=!0,d=d.substr(2)),void 0===h[d]?(h[d]=new Image,h[d].crossOrigin="Anonymous",h[d].loaded=!1,a++,function(b){h[b].addEventListener("load",function(){e++;h[b].loaded=!0;f[b]=h[b];h[b].width&&h[b].height||(h[b].src=C().src);e>=a&&c(f)});h[b].addEventListener("error",function(){e++;h[b].src=C().src;h[b].loaded=!0;f[b]=h[b];e>=a&&c(f)})}(d),k?h[d].src=d:m?(h[d].isTexture=!0,
h[d].src=q?g.settings.smallTextureFolder+d+".jpg":g.settings.textureFolder+d+".jpg"):h[d].src=g.settings.assetFolder+d+".png"):(a++,h[d].loaded?(e++,f[d]=h[d]):function(b){h[b].addEventListener("load",function(){e++;f[b]=h[b];e>=a&&c(f)})}(d));a--;0<e&&e>=a&&c(f)})}function E(b){var c=b.canvas.width,e=b.canvas.height;b=b.getImageData(0,0,c,e).data;var a,f,d=999,m=999,g=0,k=0,l=!1;for(f=e-1;-1<f&&!l;f--)for(a=0;a<c;a++)if(0<b[4*f*c+4*a+3]){k=Math.max(k,f);l=!0;break}if(void 0===k)return null;a=c-1;
a:for(;-1<a;a--)for(f=0;f<e;f++)if(0<b[4*f*c+4*a+3]){g=Math.max(g,a);break a}a=0;a:for(;a<g;a++)for(f=0;f<e;f++)if(0<b[4*f*c+4*a+3]){d=Math.min(a,d);break a}f=0;a:for(;f<k;f++)for(a=0;a<c;a++)if(0<b[4*f*c+4*a+3]){m=Math.min(m,f);break a}return{x:d,y:m,maxX:g,maxY:k,w:g-d,h:k-m}}function M(b,c,e){var a,f;a=g.races[e.language]?g.races[e.language][e.race]?g.races[e.language][e.race]:e.race:g.races.enUS[e.race]?g.races.enUS[e.race]:e.race;e=w();var d=e.getContext("2d");e.width=300;e.height=60;d.font=
"45px Belwe";d.lineCap="round";d.lineJoin="round";d.textBaseline="hanging";d.textAlign="left";a=a.split("");f=10;for(var m=0;m<a.length;m++)d.lineWidth=8,d.strokeStyle="black",d.fillStyle="black",d.fillText(a[m],f,10),d.strokeText(a[m],f,10),d.fillStyle="white",d.strokeStyle="white",d.lineWidth=1,d.fillText(a[m],f,10),f+=d.measureText(a[m]).width;a=E(d);b.drawImage(e,a.x,a.y,a.w,a.h,(394-a.w/2)*c,(1001-a.h/2)*c,a.w*c,a.h*c);u.push(e)}function z(b,c,e,a,f,d,g){var q=w(),k=q.getContext("2d");void 0===
g&&(g="0");q.width=256;q.height=256;f=f.toString();f=f.split("");var l=10;k.font=d+"px Belwe";k.lineCap="round";k.lineJoin="round";k.textBaseline="hanging";k.textAlign="left";d="white";"-"===g&&(d="#f00");"+"===g&&(d="#0f0");for(g=0;g<f.length;g++)k.lineWidth=13,k.strokeStyle="black",k.fillStyle="black",k.fillText(f[g],l,10),k.strokeText(f[g],l,10),k.fillStyle=d,k.strokeStyle=d,k.lineWidth=2.5,k.fillText(f[g],l,10),l+=k.measureText(f[g]).width;f=E(k);b.drawImage(q,f.x,f.y,f.w,f.h,(c-f.w/2)*a,(e-f.h/
2)*a,f.w*a,f.h*a);u.push(q)}function J(b,c,e,a,f,d){g.settings.debug&&(b.save(),b.strokeStyle="red",b.beginPath(),b.moveTo(d/2-a/2,f),b.lineTo(d/2+a/2,f),b.stroke(),b.restore());d=d/2-a/2;0>d&&(d=0);0<a&&0<c.width&&b.drawImage(c,0,0,a>c.width?c.width:a,c.height,d,f,Math.min(a,c.width),c.height);a=5;f+=c.height;e.clearRect(0,0,c.width,c.height);return[a,f]}function N(b,c,e){var a=w(),f=a.getContext("2d"),d=w(),m=d.getContext("2d"),q=e.textMarkdown.replace(/[\$#_]/g,"").split(" "),k,l,t=0,h=0,n,r,p,
x;a.width=520;a.height=290;d.width=520;"SPELL"===e.type&&(a.width=460,a.height=290,d.width=460);"WEAPON"===e.type&&(a.width=470,a.height=250,d.width=470);var y=g.settings.bodyFontSize;l=g.settings.bodyLineHeight;p=e.textMarkdown.replace(/\*\*/g,"").length;var v=!1;100<=p&&(y=.8*g.settings.bodyFontSize,l=.8*g.settings.bodyLineHeight);d.height=l;75<=p&&"SPELL"===e.type&&(v=!0);m.fillStyle="WEAPON"===e.type?"#fff":"#000";m.textBaseline="hanging";m.font=y+'px/1em "'+g.settings.bodyFont+'", sans-serif';
l=m.measureText(" ").width;for(p=0;p<q.length;p++){k=q[p];e=k.split("");k=m.measureText(k).width;if(t+k>d.width-10||v&&t+k>.8*d.width)v=!1,h=J(f,d,m,t,h,a.width),t=h[0],h=h[1];for(x=0;x<e.length;x++)k=e[x],"*"===k?"*"===e[x+1]?(n?(n=!1,m.font=" "+y+'px/1em "'+g.settings.bodyFont+'", sans-serif'):(n=!0,m.font="bold "+y+'px/1em "'+g.settings.bodyFont+'", sans-serif'),x+=1):r?(r=!1,m.font=" "+y+'px/1em "'+g.settings.bodyFont+'", sans-serif'):(r=!0,m.font="italic "+y+'px/1em "'+g.settings.bodyFont+'", sans-serif'):
(m.fillText(k,t+g.settings.bodyFontOffset.x,g.settings.bodyFontOffset.y),t+=m.measureText(k).width+l/8);t+=l}J(f,d,m,t,h,a.width);u.push(d);f=E(f);f.h=Math.ceil(f.h/d.height)*d.height;b.drawImage(a,f.x,f.y-2,f.w,f.h,(390-f.w/2)*c,(860-f.h/2)*c,f.w*c,(f.h+2)*c);u.push(a);g.settings.debug&&(b.save(),b.strokeStyle="green",b.beginPath(),b.rect((390-f.w/2)*c,(860-f.h/2)*c,f.w*c,(f.h+2)*c),b.stroke(),b.strokeStyle="red",b.beginPath(),b.rect((390-a.width/2)*c,(860-a.height/2)*c,a.width*c,(a.height+2)*c),
b.stroke(),b.restore())}function F(b,c){return{x:Math.pow(1-c,3)*b[0].x+3*Math.pow(1-c,2)*c*b[1].x+3*(1-c)*Math.pow(c,2)*b[2].x+Math.pow(c,3)*b[3].x,y:Math.pow(1-c,3)*b[0].y+3*Math.pow(1-c,2)*c*b[1].y+3*(1-c)*Math.pow(c,2)*b[2].y+Math.pow(c,3)*b[3].y,r:Math.atan2(3*Math.pow(1-c,2)*(b[1].y-b[0].y)+6*(1-c)*c*(b[2].y-b[1].y)+3*Math.pow(c,2)*(b[3].y-b[2].y),3*Math.pow(1-c,2)*(b[1].x-b[0].x)+6*(1-c)*c*(b[2].x-b[1].x)+3*Math.pow(c,2)*(b[3].x-b[2].x))}}function O(b,c,e){var a=w(),f=e.title;a.width=1024;
a.height=200;var d=a.getContext("2d");d.save();var m=.58,q=580,k=[{x:0,y:110},{x:102,y:137},{x:368,y:16},{x:580,y:100}];"SPELL"===e.type&&(m=.52,q=580,k=[{x:10,y:100},{x:212,y:35},{x:368,y:35},{x:570,y:105}]);"WEAPON"===e.type&&(m=.58,q=580,k=[{x:10,y:75},{x:50,y:75},{x:500,y:75},{x:570,y:75}]);e=51;d.lineWidth=13;d.strokeStyle="black";d.lineCap="round";d.lineJoin="round";d.textAlign="left";d.textBaseline="middle";for(var l=q+1;l>q&&10<e;){--e;d.font=e+"px Belwe";for(var h=l=0;h<f.length;h++)l+=d.measureText(f[h]).width+
2;l*=1.25}l/=q;m-=l/2;q=l/f.length;g.settings.debug&&(d.save(),d.strokeStyle="red",d.lineWidth=5,d.beginPath(),d.moveTo(k[0].x,k[0].y),d.bezierCurveTo(k[1].x,k[1].y,k[2].x,k[2].y,k[3].x,k[3].y),d.stroke(),d.restore());for(var n,p,h=l=0;h<f.length;h++){if(0===l)p=m+q*h,n=F(k,p),l=n.x;else for(p+=.01,n=F(k,p);n.x<l;)p+=.001,n=F(k,p);d.save();d.translate(n.x,n.y);d.scale(1.2,1);d.rotate(n.r);d.lineWidth=e/50*10;d.strokeStyle="black";d.fillStyle="black";d.fillText(f[h],0,0);d.strokeText(f[h],0,0);n=1.25*
d.measureText(f[h]).width;l+=n;-1!==["i","f"].indexOf(f[h])&&(l+=.1*n);d.fillStyle="white";d.strokeStyle="white";d.lineWidth=e/50*2.5;d.fillText(f[h],0,0);d.restore()}b.drawImage(a,0,0,580,200,105*c,525*c,580*c,200*c);u.push(a)}function P(b,c,e,a,f,d){var g=e.sunwell,h,k,l=0;k=setTimeout(function(){p("Drawing timeout at point "+l+" in "+e.title);p(e);d();f&&f(b)},5E3);"string"===typeof e.texture?h=n(e.texture):e.texture instanceof Image?h=e.texture:(h=w(),h.width=e.texture.crop.w,h.height=e.texture.crop.h,
h.getContext("2d").drawImage(e.texture.image,e.texture.crop.x,e.texture.crop.y,e.texture.crop.w,e.texture.crop.h,0,0,h.width,h.height));h||(h=n("~"));l=2;c.save();c.clearRect(0,0,b.width,b.height);l=3;c.save();"MINION"===e.type&&(I(c,180*a,75*a,430*a,590*a),c.clip(),c.drawImage(h,0,0,h.width,h.height,100*a,75*a,590*a,590*a));"SPELL"===e.type&&(c.rect(125*a,165*a,529*a,434*a),c.clip(),c.drawImage(h,0,0,h.width,h.height,125*a,117*a,529*a,529*a));"WEAPON"===e.type&&(I(c,150*a,135*a,476*a,468*a),c.clip(),
c.drawImage(h,0,0,h.width,h.height,150*a,135*a,476*a,476*a));c.restore();l=4;c.drawImage(n(g.cardBack),0,0,764,1100,0,0,b.width,b.height);l=5;c.drawImage(n("gem"),0,0,182,180,24*a,82*a,182*a,180*a);l=6;"MINION"===e.type&&(g.rarity&&c.drawImage(n(g.rarity),0,0,146,146,326*a,607*a,146*a,146*a),c.drawImage(n("title"),0,0,608,144,94*a,546*a,608*a,144*a),e.race&&c.drawImage(n("race"),0,0,529,106,125*a,937*a,529*a,106*a),c.drawImage(n("attack"),0,0,214,238,0,862*a,214*a,238*a),c.drawImage(n("health"),0,
0,167,218,575*a,876*a,167*a,218*a),"LEGENDARY"===e.rarity&&c.drawImage(n("dragon"),0,0,569,417,196*a,0,569*a,417*a));l=7;"SPELL"===e.type&&(g.rarity&&c.drawImage(n(g.rarity),0,0,149,149,311*a,607*a,150*a,150*a),c.drawImage(n("title-spell"),0,0,646,199,66*a,530*a,646*a,199*a));"WEAPON"===e.type&&(g.rarity&&c.drawImage(n(g.rarity),0,0,146,144,315*a,592*a,146*a,144*a),c.drawImage(n("title-weapon"),0,0,660,140,56*a,551*a,660*a,140*a),c.drawImage(n("swords"),0,0,312,306,32*a,906*a,187*a,183*a),c.drawImage(n("shield"),
0,0,301,333,584*a,890*a,186*a,205*a));l=8;"CORE"!==e.set&&function(){var b;"SPELL"===e.type&&(b=265);"MINION"===e.type&&(b=265);e.race&&"MINION"===e.type?c.drawImage(n(g.bgLogo),0,0,281,244,b*a,734*a,266.95*a,244*.95*a):"SPELL"===e.type?c.drawImage(n(g.bgLogo),0,0,281,244,b*a,740*a,253*a,220*a):c.drawImage(n(g.bgLogo),0,0,281,244,b*a,734*a,281*a,244*a)}();l=9;l=10;z(c,116,170,a,e.cost||0,170,e.costStyle);l=11;O(c,a,e);l=12;"MINION"===e.type&&(e.race&&M(c,a,e),z(c,128,994,a,e.attack||0,150,e.attackStyle),
z(c,668,994,a,e.health||0,150,e.healthStyle));l=13;"WEAPON"===e.type&&(z(c,128,994,a,e.attack||0,150,e.attackStyle),z(c,668,994,a,e.durability||0,150,e.durabilityStyle));l=14;N(c,a,e);c.restore();clearTimeout(k);d();f&&f(b)}function G(b,c,e){A.push([b,c,e]);B||H()}function H(){K&&(Q(),window.requestAnimationFrame(H))}function Q(){if(!(12<B)){var b,c,e;if(A.length){var a=A.shift();B++;b=a[0];c=a[1];e=a[2];p("Preparing assets for: "+b.title);var f=w(),d=f.getContext("2d"),g=(c||512)/764,a=[];f.width=
c||512;f.height=Math.round(1.4397905759*f.width);b.sunwell=b.sunwell||{};b.sunwell.cardBack=b.type.substr(0,1).toLowerCase()+b.playerClass.substr(0,1)+b.playerClass.substr(1).toLowerCase();a.push(b.sunwell.cardBack);a.push("gem");"MINION"===b.type&&(a.push("attack","health","title"),"LEGENDARY"===b.rarity&&a.push("dragon"),"FREE"===b.rarity||"COMMON"===b.rarity&&"CORE"===b.set||(b.sunwell.rarity="rarity-"+b.rarity.toLowerCase(),a.push(b.sunwell.rarity)));"SPELL"===b.type&&(a.push("attack","health",
"title-spell"),"FREE"===b.rarity||"COMMON"===b.rarity&&"CORE"===b.set||(b.sunwell.rarity="spell-rarity-"+b.rarity.toLowerCase(),a.push(b.sunwell.rarity)));"WEAPON"===b.type&&(a.push("swords","shield","title-weapon"),"FREE"===b.rarity||"COMMON"===b.rarity&&"CORE"===b.set||(b.sunwell.rarity="weapon-rarity-"+b.rarity.toLowerCase(),a.push(b.sunwell.rarity)));-1==="BRM GVG LOE NAX TGT WOG".split(" ").indexOf(b.set)?b.sunwell.bgLogo="bg-cl":b.sunwell.bgLogo="bg-"+b.set.toLowerCase();"SPELL"===b.type&&(b.sunwell.bgLogo=
"spell-"+b.sunwell.bgLogo);a.push(b.sunwell.bgLogo);b.race&&a.push("race");"string"===typeof b.texture&&"CHEAT"!==b.set&&(.5>=g?a.push("h:"+b.texture):a.push("t:"+b.texture));p("Assets prepared, now loading");L(a).then(function(){p("Assets loaded for: "+b.title);P(f,d,b,g,e,function(){B--;p("Card rendered: "+b.title);u.push(f)})})}}}var g,h={},K=!1,A=[],B=0,r={},u=[],R=["COMMON","RARE","EPIC","LEGENDARY"],v;window.sunwell=g=window.sunwell||{};g._buffers=u;g._renderQuery=A;g._activeRenders=B;g.settings=
g.settings||{};g.settings.titleFont=g.settings.titleFont||"Belwe Bold";g.settings.bodyFont=g.settings.bodyFont||"ITC Franklin Condensed";g.settings.bodyFontSize=g.settings.bodyFontSize||60;g.settings.bodyFontOffset=g.settings.bodyFontOffset||{x:0,y:0};g.settings.bodyLineHeight=g.settings.bodyLineHeight||50;g.settings.assetFolder=g.settings.assetFolder||"/assets/";g.settings.textureFolder=g.settings.textureFolder||"/artwork/";g.settings.smallTextureFolder=g.settings.smallTextureFolder||null;g.settings.autoInit=
g.settings.autoInit||!0;g.settings.idAsTexture=g.settings.idAsTexture||!1;g.settings.debug=g.settings.debug||!1;g.init=function(){K=!0;A.length&&H()};g.settings.autoInit||g.init();g.races={enUS:{MURLOC:"Murloc",MECHANICAL:"Mech",BEAST:"Beast",DEMON:"Demon",PIRATE:"Pirate",DRAGON:"Dragon",TOTEM:"Totem"},deDE:{MURLOC:"Murloc",MECHANICAL:"Mech",BEAST:"Wildtier",DEMON:"D\u00e4mon",PIRATE:"Pirat",DRAGON:"Drache",TOTEM:"Totem"}};h.empty=new Image;h.empty.src=C();g.clearCache=function(){r={}};g.createCard=
function(b,c,e){if(!b)throw Error("No card object given");e||(e=new Image);-1===R.indexOf(b.rarity)&&(b.rarity="FREE");void 0===b.title&&(b.title=b.name);void 0===b.gameId&&(b.gameId=b.id);void 0===b.textMarkdown&&(b.textMarkdown=b.text.replace(/<\/*b>/g,"**"));g.settings.idAsTexture&&(b.texture=b.gameId);b.costStyle=b.costStyle||"0";b.healthStyle=b.healthStyle||"0";b.attackStyle=b.attackStyle||"0";b.durabilityStyle=b.durabilityStyle||"0";b.width=c;var a=D(b);if(r[a])e.src=r[a];else return p("Queried render: "+
b.title),G(b,c,function(b){e.src=r[a]=b.toDataURL()}),{target:e,redraw:function(){a=D(b);delete r[a];G(b,c,function(b){e.src=r[a]=b.toDataURL()})},update:function(f){for(var d in f)b[d]=f[d];a=D(b);r[a]?e.src=r[a]:G(b,c,function(b){e.src=r[a]=b.toDataURL()})}}}})();