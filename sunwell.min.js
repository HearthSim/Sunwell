/**
 * Sunwell
 * =======
 * Sunwell is a renderer for hearthstone cards.
 *
 * @author Christian Engel <hello@wearekiss.com>
 */
(function(){function C(){return A.length?A.pop():document.createElement("canvas")}function J(a,k,f,c,g){var d=c/2*.5522848,b=g/2*.5522848,t=k+c,e=f+g;c=k+c/2;g=f+g/2;a.beginPath();a.moveTo(k,g);a.bezierCurveTo(k,g-b,c-d,f,c,f);a.bezierCurveTo(c+d,f,t,g-b,t,g);a.bezierCurveTo(t,g+b,c+d,e,c,e);a.bezierCurveTo(c-d,e,k,g+b,k,g);a.stroke()}function N(a){return new Promise(function(k){for(var w=0,c=1,g={},d,b,t,e,h=0;h<a.length;h++)d=a[h],t=b=!1,"h:"===d.substr(0,2)&&(b=!0,t=!!f.settings.smallTextureFolder,
d=d.substr(2)),"t:"===d.substr(0,2)&&(b=!0,d=d.substr(2),void 0!==l[d]&&256===l[d].width&&(l[d]=void 0)),"u:"===d.substr(0,2)&&(e=!0,d=d.substr(2)),void 0===l[d]?(l[d]=new Image,l[d].loaded=!1,c++,function(a){l[a].addEventListener("load",function(){w++;l[a].loaded=!0;g[a]=l[a];w>=c&&k(g)})}(d),l[d].src=e?d:b?t?f.settings.smallTextureFolder+d+".jpg":f.settings.textureFolder+d+".jpg":f.settings.assetFolder+d+".png"):(c++,l[d].loaded?(w++,g[d]=l[d]):function(a){l[a].addEventListener("load",function(){w++;
g[a]=l[a];w>=c&&k(g)})}(d));c--;0<w&&w>=c&&k(g)})}function G(a){var k=a.canvas.width,f=a.canvas.height;a=a.getImageData(0,0,k,f).data;var c,g,d=999,b=999,t=0,e=0,h=!1;for(g=f-1;-1<g&&!h;g--)for(c=0;c<k;c++)if(0<a[4*g*k+4*c+3]){e=Math.max(e,g);h=!0;break}if(void 0===e)return null;c=k-1;a:for(;-1<c;c--)for(g=0;g<f;g++)if(0<a[4*g*k+4*c+3]){t=Math.max(t,c);break a}c=0;a:for(;c<t;c++)for(g=0;g<f;g++)if(0<a[4*g*k+4*c+3]){d=Math.min(c,d);break a}g=0;a:for(;g<e;g++)for(c=0;c<k;c++)if(0<a[4*g*k+4*c+3]){b=
Math.min(b,g);break a}return{x:d,y:b,maxX:t,maxY:e,w:t-d,h:e-b}}function E(a,k,f,c,g,d,b,t){var e=C(),h=e.getContext("2d");void 0===b&&(b=g);e.width=256;e.height=256;g=g.toString();g=g.split("");var l=10;h.font=d+"px Belwe";h.lineCap="round";h.lineJoin="round";h.textBaseline="hanging";h.textAlign="left";d="white";t?(g>b&&(d="#f00"),g<b&&(d="#0f0")):(g<b&&(d="#f00"),g>b&&(d="#0f0"));for(b=0;b<g.length;b++)h.lineWidth=13,h.strokeStyle="black",h.fillStyle="black",h.fillText(g[b],l,10),h.strokeText(g[b],
l,10),h.fillStyle=d,h.strokeStyle=d,h.lineWidth=2.5,h.fillText(g[b],l,10),l+=h.measureText(g[b]).width;g=G(h);a.drawImage(e,g.x,g.y,g.w,g.h,(k-g.w/2)*c,(f-g.h/2)*c,g.w*c,g.h*c);A.push(e)}function K(a,k,l,c,g,d){f.settings.debug&&(a.save(),a.strokeStyle="red",a.beginPath(),a.moveTo(d/2-c/2,g),a.lineTo(d/2+c/2,g),a.stroke(),a.restore());a.drawImage(k,0,0,c,k.height,d/2-c/2,g,c,k.height);c=5;g+=k.height;l.clearRect(0,0,540,k.height);return[c,g]}function H(a,f){return{x:Math.pow(1-f,3)*a[0].x+3*Math.pow(1-
f,2)*f*a[1].x+3*(1-f)*Math.pow(f,2)*a[2].x+Math.pow(f,3)*a[3].x,y:Math.pow(1-f,3)*a[0].y+3*Math.pow(1-f,2)*f*a[1].y+3*(1-f)*Math.pow(f,2)*a[2].y+Math.pow(f,3)*a[3].y,r:Math.atan2(3*Math.pow(1-f,2)*(a[1].y-a[0].y)+6*(1-f)*f*(a[2].y-a[1].y)+3*Math.pow(f,2)*(a[3].y-a[2].y),3*Math.pow(1-f,2)*(a[1].x-a[0].x)+6*(1-f)*f*(a[2].x-a[1].x)+3*Math.pow(f,2)*(a[3].x-a[2].x))}}function L(a,f,l){z.push([a,f,l]);F||I()}function I(){M&&(O(),window.requestAnimationFrame(I))}function O(){if(!(8<F)){var a,k,w;if(z.length){var c=
z.shift();F++;a=c[0];k=c[1];w=c[2];var g=C(),d=g.getContext("2d"),b=(k||512)/764,c=[];g.width=k||512;g.height=Math.round(1.4397905759*g.width);a.sunwell=a.sunwell||{};a.sunwell.cardBack=a.type.substr(0,1).toLowerCase()+a.playerClass.substr(0,1)+a.playerClass.substr(1).toLowerCase();"mNeutral"===a.sunwell.cardBack&&(a.sunwell.cardBack="mGeneric");c.push(a.sunwell.cardBack);c.push("gem");"MINION"===a.type&&(c.push("attack","health","title"),"LEGENDARY"===a.rarity&&c.push("dragon"),"FREE"!==a.rarity&&
(a.sunwell.rarity="rarity-"+a.rarity.toLowerCase(),c.push(a.sunwell.rarity)));"SPELL"===a.type&&(c.push("attack","health","title-spell"),"FREE"!==a.rarity&&(a.sunwell.rarity="spell-rarity-"+a.rarity.toLowerCase(),c.push(a.sunwell.rarity)));"WEAPON"===a.type&&(c.push("swords","shield","title-weapon"),"FREE"!==a.rarity&&(a.sunwell.rarity="weapon-rarity-"+a.rarity.toLowerCase(),c.push(a.sunwell.rarity)));-1===["BRM","GVG","LOE","NAX","TGT"].indexOf(a.set)?a.sunwell.bgLogo="bg-cl":a.sunwell.bgLogo="bg-"+
a.set.toLowerCase();c.push(a.sunwell.bgLogo);a.race&&c.push("race");.5>=b?c.push("h:"+a.texture):c.push("t:"+a.texture);N(c).then(function(){var c=a.sunwell,e=l[a.texture];d.save();d.clearRect(0,0,g.width,g.height);d.save();"MINION"===a.type&&(J(d,180*b,75*b,430*b,590*b),d.clip(),d.drawImage(e,0,0,e.width,e.height,100*b,75*b,590*b,590*b));"SPELL"===a.type&&(d.rect(125*b,165*b,529*b,434*b),d.clip(),d.drawImage(e,0,0,e.width,e.height,125*b,117*b,529*b,529*b));"WEAPON"===a.type&&(J(d,150*b,135*b,476*
b,468*b),d.clip(),d.drawImage(e,0,0,e.width,e.height,150*b,135*b,476*b,476*b));d.restore();d.drawImage(l[c.cardBack],0,0,764,1100,0,0,g.width,g.height);d.drawImage(l.gem,0,0,182,180,24*b,82*b,182*b,180*b);"MINION"===a.type&&(c.rarity&&d.drawImage(l[c.rarity],0,0,146,146,326*b,607*b,146*b,146*b),d.drawImage(l.title,0,0,608,144,94*b,546*b,608*b,144*b),a.race&&d.drawImage(l.race,0,0,529,106,125*b,937*b,529*b,106*b),d.drawImage(l.attack,0,0,214,238,0,862*b,214*b,238*b),d.drawImage(l.health,0,0,167,218,
575*b,876*b,167*b,218*b),"LEGENDARY"===a.rarity&&d.drawImage(l.dragon,0,0,569,417,196*b,0,569*b,417*b));"SPELL"===a.type&&(c.rarity&&d.drawImage(l[c.rarity],0,0,150,150,311*b,607*b,150*b,150*b),d.drawImage(l["title-spell"],0,0,646,199,66*b,530*b,646*b,199*b));"WEAPON"===a.type&&(c.rarity&&d.drawImage(l[c.rarity],0,0,146,144,315*b,592*b,146*b,144*b),d.drawImage(l["title-weapon"],0,0,660,140,56*b,551*b,660*b,140*b),d.drawImage(l.swords,0,0,312,306,32*b,906*b,187*b,183*b),d.drawImage(l.shield,0,0,301,
333,584*b,890*b,186*b,205*b));if("CORE"!==a.set){var h;"SPELL"===a.type&&(h=245);"MINION"===a.type&&(h=265);a.race?d.drawImage(l[c.bgLogo],0,0,281,244,h*b,734*b,266.95*b,244*.95*b):d.drawImage(l[c.bgLogo],0,0,281,244,h*b,734*b,281*b,244*b)}c=C();h=c.getContext("2d");var e=C(),k=e.getContext("2d"),u=a.textMarkdown.replace(/[\$#_]/g,"").split(" "),x,n,y,r=0,D=0,m,z,B;h.setTransform(1,0,0,1,0,0);k.setTransform(1,0,0,1,0,0);c.centerLeft=390;c.centerTop=860;c.width=540;c.height=290;e.width=540;e.height=
f.settings.bodyLineHeight;"SPELL"===a.type&&(c.width=460,c.height=290,e.width=460);"WEAPON"===a.type&&(c.width=470,c.height=250,e.width=470);var p=f.settings.bodyFontSize,q=!1;n=a.textMarkdown.replace(/\*\*/g,"").length;75<n&&("SPELL"===a.type&&(q=!0),80<n&&(p=.6*f.settings.bodyFontSize));k.fillStyle="WEAPON"===a.type?"#fff":"#000";k.textBaseline="hanging";k.font=p+'px/1em "'+f.settings.bodyFont+'", sans-serif';y=k.measureText(" ").width;for(z=0;z<u.length;z++){x=u[z];n=x.split("");x=k.measureText(x).width;
if(r+x>e.width||q&&r+x>.6*e.width)q=!1,D=K(h,e,k,r,D,c.width),r=D[0],D=D[1];for(B=0;B<n.length;B++)x=n[B],"*"===x?("*"===n[B+1]&&(m?(m=!1,k.font=" "+p+'px/1em "'+f.settings.bodyFont+'", sans-serif'):(m=!0,k.font="bold "+p+'px/1em "'+f.settings.bodyFont+'", sans-serif')),B+=1):(k.fillText(x,r+f.settings.bodyFontOffset.x,f.settings.bodyFontOffset.y),r+=k.measureText(x).width+y/8);r+=y}K(h,e,k,r,D,c.width);A.push(e);m=G(h);m.h=Math.ceil(m.h/e.height)*e.height;d.drawImage(c,m.x,m.y-2,m.w,m.h,(c.centerLeft-
m.w/2)*b,(c.centerTop-m.h/2)*b,m.w*b,(m.h+2)*b);A.push(c);f.settings.debug&&(d.save(),d.strokeStyle="green",d.beginPath(),d.rect((c.centerLeft-m.w/2)*b,(c.centerTop-m.h/2)*b,m.w*b,(m.h+2)*b),d.stroke(),d.strokeStyle="red",d.beginPath(),d.rect((c.centerLeft-c.width/2)*b,(c.centerTop-c.height/2)*b,c.width*b,(c.height+2)*b),d.stroke(),d.restore());E(d,116,170,b,a.cost||0,170,a._originalCost,!0);m=C();c=a.title;m.width=1024;m.height=200;e=m.getContext("2d");e.save();r=.58;q=580;h=[{x:0,y:110},{x:102,
y:137},{x:368,y:16},{x:580,y:100}];"SPELL"===a.type&&(r=.52,q=580,h=[{x:10,y:100},{x:212,y:35},{x:368,y:35},{x:570,y:105}]);"WEAPON"===a.type&&(r=.58,q=580,h=[{x:10,y:75},{x:50,y:75},{x:500,y:75},{x:570,y:75}]);k=51;e.lineWidth=13;e.strokeStyle="black";e.lineCap="round";e.lineJoin="round";e.textAlign="left";e.textBaseline="middle";for(p=q+1;p>q&&10<k;){--k;e.font=k+"px Belwe";for(u=p=0;u<c.length;u++)p+=e.measureText(c[u]).width+2;p*=1.25}p/=q;r-=p/2;p/=c.length;f.settings.debug&&(e.save(),e.strokeStyle=
"red",e.lineWidth=5,e.beginPath(),e.moveTo(h[0].x,h[0].y),e.bezierCurveTo(h[1].x,h[1].y,h[2].x,h[2].y,h[3].x,h[3].y),e.stroke(),e.restore());for(var v,u=q=0;u<c.length;u++){if(0===q)v=r+p*u,n=H(h,v),q=n.x;else for(v+=.01,n=H(h,v);n.x<q;)v+=.001,n=H(h,v);e.save();e.translate(n.x,n.y);e.scale(1.2,1);e.rotate(n.r);e.lineWidth=k/50*10;e.strokeStyle="black";e.fillStyle="black";e.fillText(c[u],0,0);e.strokeText(c[u],0,0);n=1.25*e.measureText(c[u]).width;q+=n;-1!==["i","f"].indexOf(c[u])&&(q+=.1*n);e.fillStyle=
"white";e.strokeStyle="white";e.lineWidth=k/50*2.5;e.fillText(c[u],0,0);e.restore()}d.drawImage(m,0,0,580,200,105*b,525*b,580*b,200*b);A.push(m);if("MINION"===a.type){if(a.race){m=f.races[a.language]?f.races[a.language][a.race]:f.races.enUS[a.race];v=C();e=v.getContext("2d");v.width=300;v.height=60;e.font="45px Belwe";e.lineCap="round";e.lineJoin="round";e.textBaseline="hanging";e.textAlign="left";m=m.split("");c=10;for(h=0;h<m.length;h++)e.lineWidth=8,e.strokeStyle="black",e.fillStyle="black",e.fillText(m[h],
c,10),e.strokeText(m[h],c,10),e.fillStyle="white",e.strokeStyle="white",e.lineWidth=1,e.fillText(m[h],c,10),c+=e.measureText(m[h]).width;m=G(e);d.drawImage(v,m.x,m.y,m.w,m.h,(394-m.w/2)*b,(1001-m.h/2)*b,m.w*b,m.h*b);A.push(v)}E(d,128,994,b,a.attack||0,150,a._originalAttack);E(d,668,994,b,a.health||0,150,a._originalHealth)}"WEAPON"===a.type&&(E(d,128,994,b,a.attack||0,150,a._originalAttack),E(d,668,994,b,a.durability||0,150,a._originalHealth));d.restore();w&&w(g);F--;A.push(g)})}}}var f,l={},M=!1,
z=[],F=0,y={},A=[];window.sunwell=f=window.sunwell||{};f.settings=f.settings||{};f.settings.titleFont=f.settings.titleFont||"Belwe Bold";f.settings.bodyFont=f.settings.bodyFont||"ITC Franklin Condensed";f.settings.bodyFontSize=f.settings.bodyFontSize||60;f.settings.bodyFontOffset=f.settings.bodyFontOffset||{x:0,y:0};f.settings.bodyLineHeight=f.settings.bodyLineHeight||50;f.settings.assetFolder=f.settings.assetFolder||"/assets/";f.settings.textureFolder=f.settings.textureFolder||"/artwork/";f.settings.smallTextureFolder=
f.settings.smallTextureFolder||null;f.settings.autoInit=f.settings.autoInit||!0;f.settings.debug=f.settings.debug||!1;f.init=function(){M=!0;z.length&&I()};f.settings.autoInit||f.init();f.races={enUS:{MURLOC:"Murloc",MECHANICAL:"Mech",BEAST:"Beast",DEMON:"Demon",PIRATE:"Pirate",DRAGON:"Dragon",TOTEM:"Totem"},deDE:{MURLOC:"Murloc",MECHANICAL:"Mech",BEAST:"Wildtier",DEMON:"D\u00e4mon",PIRATE:"Pirat",DRAGON:"Drache",TOTEM:"Totem"}};f.createCard=function(a,f,l){if(!a)throw Error("No card object given");
l||(l=new Image);void 0===a.title&&(a.title=a.name);void 0===a.gameId&&(a.gameId=a.id);void 0===a.textMarkdown&&(a.textMarkdown=a.text.replace(/<\/*b>/g,"**"));var c=f+"_"+a.language+"_"+a.gameId+"_"+a.cost+"_"+a.attack+"_"+a.health;a._originalCost=a.cost;a._originalHealth=a.health;a._originalAttack=a.attack;if(y[c])l.src=y[c];else return L(a,f,function(a){l.src=y[c]=a.toDataURL()}),{target:l,update:function(g){for(var d in g)a[d]=g[d];c=f+"_"+a.language+"_"+a.gameId+"_"+a.cost+"_"+a.attack+"_"+a.health+
"_"+a.health;y[c]?l.src=y[c]:L(a,f,function(a){l.src=y[c]=a.toDataURL()})}}}})();