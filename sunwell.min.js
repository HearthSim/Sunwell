/**
 * Sunwell
 * =======
 * Sunwell is a renderer for hearthstone cards.
 *
 * @author Christian Engel <hello@wearekiss.com>
 */
!function(){"use strict";function e(e){b.settings.debug&&console.log(e)}function t(e,t,r){var i;if(k.length){if(e){for(var a=0;a<k.length;a++)if(k[a].width===e&&k[a].height===t){i=k.splice(a,1)[0];break}}else i=k.pop();if(i)return r&&i.getContext("2d").clearRect(0,0,i.width,i.height),i}return i=document.createElement("canvas"),e&&(i.width=e,i.height=t),i}function r(e){k.push(e)}function i(r){if(e("Substitute for "+r),m)return m;var i=t(),a=i.getContext("2d");return i.width=i.height=512,a.save(),a.fillStyle="grey",a.fillRect(0,0,512,512),a.fill(),a.fillStyle="red",a.textAlign="center",a.textBaseline="middle",a.font="50px Belwe",a.fillText("missing artwork",256,256),a.restore(),m=new Image,m.src=i.toDataURL(),m}function a(e){return v[e]||i(e)}function n(e){var t,r="",i=305419896;for(r+=e.gameId,r+=e.playerClass,r+=e.race,r+=e.rarity,r+=e.set,r+=e.silenced,r+=e.costHealth,r+=e.texture,r+=e.type,r+=e.width,t=0;t<r.length;t++)i+=r.charCodeAt(t)*(t+1);return i}function s(e,t,r,i,a){var n=.5522848,s=i/2*n,l=a/2*n,o=t+i,h=r+a,d=t+i/2,g=r+a/2;e.beginPath(),e.moveTo(t,g),e.bezierCurveTo(t,g-l,d-s,r,d,r),e.bezierCurveTo(d+s,r,o,g-l,o,g),e.bezierCurveTo(o,g+l,d+s,h,d,h),e.bezierCurveTo(d-s,h,t,g+l,t,g),e.stroke()}function l(t){return new Promise(function(r){for(var a,n,s,l,o,h=0,d=1,g={},u=0;u<t.length;u++)a=t[u],n=!1,s=!1,"h:"===a.substr(0,2)&&(n=!0,s=!!b.settings.smallTextureFolder,a=a.substr(2)),"t:"===a.substr(0,2)&&(n=!0,a=a.substr(2),void 0!==v[a]&&256===v[a].width&&(v[a]=void 0)),"u:"===a.substr(0,2)&&(l=!0,a=a.substr(2)),void 0===v[a]?(v[a]=new Image,v[a].crossOrigin="Anonymous",v[a].loaded=!1,d++,function(e){v[e].addEventListener("load",function(){h++,v[e].loaded=!0,g[e]=v[e],v[e].width&&v[e].height||(v[e].src=i().src),h>=d&&r(g)}),v[e].addEventListener("error",function(){h++,v[e].src=i().src,v[e].loaded=!0,g[e]=v[e],h>=d&&r(g)})}(a),l?v[a].src=a:(n?(v[a].isTexture=!0,o=s?b.settings.smallTextureFolder+a+".jpg":b.settings.textureFolder+a+".jpg"):o=b.settings.assetFolder+a+".png",e("Requesting "+o),v[a].src=o)):(d++,v[a].loaded?(h++,g[a]=v[a]):!function(e){v[e].addEventListener("load",function(){h++,g[e]=v[e],h>=d&&r(g)})}(a));d--,h>0&&h>=d&&r(g)})}function o(e){var t,r,i=e.canvas.width,a=e.canvas.height,n=e.getImageData(0,0,i,a).data,s=999,l=999,o=0,h=0,d=!1;for(r=a-1;r>-1&&!d;r--)for(t=0;i>t;t++)if(n[r*(4*i)+4*t+3]>0){h=Math.max(h,r),d=!0;break}if(void 0===h)return null;e:for(t=i-1;t>-1;t--)for(r=0;a>r;r++)if(n[r*(4*i)+4*t+3]>0){o=Math.max(o,t);break e}e:for(t=0;o>t;t++)for(r=0;a>r;r++)if(n[r*(4*i)+4*t+3]>0){s=Math.min(t,s);break e}e:for(r=0;h>r;r++)for(t=0;i>t;t++)if(n[r*(4*i)+4*t+3]>0){l=Math.min(l,r);break e}return{x:s,y:l,maxX:o,maxY:h,w:o-s,h:h-l}}function h(e,i,a){var n,s;n=b.races[a.language]?b.races[a.language][a.race]?b.races[a.language][a.race]:a.race:b.races.enUS[a.race]?b.races.enUS[a.race]:a.race;var l=t(),h=l.getContext("2d");l.width=300,l.height=60,h.font="45px Belwe",h.lineCap="round",h.lineJoin="round",h.textBaseline="hanging",h.textAlign="left",n=n.split(""),s=10;for(var d=0;d<n.length;d++)h.lineWidth=8,h.strokeStyle="black",h.fillStyle="black",h.fillText(n[d],s,10),h.strokeText(n[d],s,10),h.fillStyle="white",h.strokeStyle="white",h.lineWidth=1,h.fillText(n[d],s,10),s+=h.measureText(n[d]).width;var g=o(h);e.drawImage(l,g.x,g.y,g.w,g.h,(394-g.w/2)*i,(1001-g.h/2)*i,g.w*i,g.h*i),r(l)}function d(e,i,a,n,s,l,h){var d=t(),g=d.getContext("2d");void 0===h&&(h="0"),d.width=256,d.height=256,s=s.toString(),s=s.split("");var u=10;g.font=l+"px Belwe",g.lineCap="round",g.lineJoin="round",g.textBaseline="hanging",g.textAlign="left";var c="white";"-"===h&&(c="#f00"),"+"===h&&(c="#0f0");for(var w=0;w<s.length;w++)g.lineWidth=13,g.strokeStyle="black",g.fillStyle="black",g.fillText(s[w],u,10),g.strokeText(s[w],u,10),g.fillStyle=c,g.strokeStyle=c,g.lineWidth=2.5,g.fillText(s[w],u,10),u+=g.measureText(s[w]).width;var y=o(g);e.drawImage(d,y.x,y.y,y.w,y.h,(i-y.w/2)*n,(a-y.h/2)*n,y.w*n,y.h*n),r(d)}function g(e,t,r,i,a,n){b.settings.debug&&(e.save(),e.strokeStyle="red",e.beginPath(),e.moveTo(n/2-i/2,a),e.lineTo(n/2+i/2,a),e.stroke(),e.restore());var s=n/2-i/2;return 0>s&&(s=0),i>0&&t.width>0&&e.drawImage(t,0,0,i>t.width?t.width:i,t.height,s,a,Math.min(i,t.width),t.height),i=5,a+=t.height,r.clearRect(0,0,t.width,t.height),[i,a]}function u(i,a,n,s){var l,h,d,c,w,y,f,p,x,m,v,I,S,C,E="[x]"===n.text.substr(0,3),L=t(),k=L.getContext("2d"),M=t(),O=M.getContext("2d"),A=E?n.text.substr(3):n.text,N=0,R=0,F=0,P=0,_=0;for(C=A;null!==(S=T.exec(A));)C=C.replace(S[0],S[1]+S[2]+(1===parseInt(S[1],10)?S[3]:S[4]));A=C,l=A.replace(/[\$#_]/g,"").split(/( |\n)/g),e("Rendering body: "+A),m=390,v=860,L.width=520,L.height=290,M.width=520,"SPELL"===n.type&&(L.width=460,L.height=290,M.width=460),"WEAPON"===n.type&&(L.width=470,L.height=250,M.width=470);var B=b.settings.bodyFontSize,D=b.settings.bodyLineHeight,W=n.text.replace(/<\/*.>/g,"").length,H=!1;for(W>=80&&(B=.9*b.settings.bodyFontSize,D=.9*b.settings.bodyLineHeight),W>=100&&(B=.8*b.settings.bodyFontSize,D=.8*b.settings.bodyLineHeight),M.height=D,W>=75&&"SPELL"===n.type&&(H=!0),s&&(H=!0),"WEAPON"===n.type?O.fillStyle="#fff":O.fillStyle="#000",O.textBaseline="hanging",O.font=B+'px/1em "'+b.settings.bodyFont+'", sans-serif',y=3,f=0;f<l.length;f++){for(h=l[f],d=h.split(""),w=O.measureText(h).width,e("Next word: "+h),!E&&(N+w>M.width||H&&N+w>.8*M.width)&&(e(N+w+" > "+M.width),e("Calculated line break"),H=!1,_++,x=g(k,M,O,N,R,L.width),N=x[0],R=x[1],I=!0),p=0;p<d.length;p++)if(c=d[p],e(c+" "+c.charCodeAt(0)),10!==c.charCodeAt(0))I=!1,"<"!==c?(O.fillText(c,N+b.settings.bodyFontOffset.x,b.settings.bodyFontOffset.y),N+=O.measureText(c).width+y/8):("/"===d[p+1]?("b"===d[p+2]&&(F--,p+=3),"i"===d[p+2]&&(P--,p+=3)):("b"===d[p+1]&&(F++,p+=2),"i"===d[p+1]&&(P++,p+=2)),O.font=(F>0?"bold ":"")+(P>0?"italic":"")+" "+B+'px/1em "'+b.settings.bodyFont+'", sans-serif');else{if(I){I=!1;continue}_++,x=g(k,M,O,N,R,L.width),N=x[0],R=x[1],e("Manual line break")}N+=y}if(_++,g(k,M,O,N,R,L.width),r(M),"SPELL"===n.type&&4===_&&!H&&!s)return void u(i,a,n,!0);var z=o(k);z.h=Math.ceil(z.h/M.height)*M.height,i.drawImage(L,z.x,z.y-2,z.w,z.h,(m-z.w/2)*a,(v-z.h/2)*a,z.w*a,(z.h+2)*a),r(L),b.settings.debug&&(i.save(),i.strokeStyle="green",i.beginPath(),i.rect((m-z.w/2)*a,(v-z.h/2)*a,z.w*a,(z.h+2)*a),i.stroke(),i.strokeStyle="red",i.beginPath(),i.rect((m-L.width/2)*a,(v-L.height/2)*a,L.width*a,(L.height+2)*a),i.stroke(),i.restore())}function c(e,t){var r,i,a,n;return r=3*Math.pow(1-t,2)*(e[1].x-e[0].x)+6*(1-t)*t*(e[2].x-e[1].x)+3*Math.pow(t,2)*(e[3].x-e[2].x),i=3*Math.pow(1-t,2)*(e[1].y-e[0].y)+6*(1-t)*t*(e[2].y-e[1].y)+3*Math.pow(t,2)*(e[3].y-e[2].y),a=Math.pow(1-t,3)*e[0].x+3*Math.pow(1-t,2)*t*e[1].x+3*(1-t)*Math.pow(t,2)*e[2].x+Math.pow(t,3)*e[3].x,n=Math.pow(1-t,3)*e[0].y+3*Math.pow(1-t,2)*t*e[1].y+3*(1-t)*Math.pow(t,2)*e[2].y+Math.pow(t,3)*e[3].y,{x:a,y:n,r:Math.atan2(i,r)}}function w(e,i,a){var n=t(),s=a.title;n.width=1024,n.height=200;var l=n.getContext("2d");l.save();var o=.58,h=580,d=[{x:0,y:110},{x:102,y:137},{x:368,y:16},{x:580,y:100}];"SPELL"===a.type&&(o=.52,h=580,d=[{x:10,y:100},{x:212,y:35},{x:368,y:35},{x:570,y:105}]),"WEAPON"===a.type&&(o=.58,h=580,d=[{x:10,y:75},{x:50,y:75},{x:500,y:75},{x:570,y:75}]);var g=51;l.lineWidth=13,l.strokeStyle="black",l.lineCap="round",l.lineJoin="round",l.textAlign="left",l.textBaseline="middle";for(var u,w,y=h+1;y>h&&g>10;){g-=1,l.font=g+"px Belwe",y=0;for(var f=0;f<s.length;f++)y+=l.measureText(s[f]).width+2;y*=1.25}y/=h,w=o-y/2,u=y/s.length,b.settings.debug&&(l.save(),l.strokeStyle="red",l.lineWidth=5,l.beginPath(),l.moveTo(d[0].x,d[0].y),l.bezierCurveTo(d[1].x,d[1].y,d[2].x,d[2].y,d[3].x,d[3].y),l.stroke(),l.restore());var p,x,m,v=0;for(f=0;f<s.length;f++){if(0===v)x=w+u*f,p=c(d,x),v=p.x;else for(x+=.01,p=c(d,x);p.x<v;)x+=.001,p=c(d,x);l.save(),l.translate(p.x,p.y),l.scale(1.2,1),l.rotate(p.r),l.lineWidth=10*(g/50),l.strokeStyle="black",l.fillStyle="black",l.fillText(s[f],0,0),l.strokeText(s[f],0,0),m=1.25*l.measureText(s[f]).width,v+=m,-1!==["i","f"].indexOf(s[f])&&(v+=.1*m),l.fillStyle="white",l.strokeStyle="white",l.lineWidth=2.5*(g/50),l.fillText(s[f],0,0),l.restore()}e.drawImage(n,0,0,580,200,105*i,525*i,580*i,200*i),r(n)}function y(r,i,n,l,o,g){var c,y,f=n.sunwell,p=0,x=Date.now();y=setTimeout(function(){e("Drawing timeout at point "+p+" in "+n.title),e(n),g()},5e3),"string"==typeof n.texture?c=a(n.texture):n.texture instanceof Image?c=n.texture:(c=t(),c.width=n.texture.crop.w,c.height=n.texture.crop.h,function(){var e=c.getContext("2d");e.drawImage(n.texture.image,n.texture.crop.x,n.texture.crop.y,n.texture.crop.w,n.texture.crop.h,0,0,c.width,c.height)}()),c||(c=a("~")),p=2,i.save(),i.clearRect(0,0,r.width,r.height),L[n._cacheKey]?(e("Skipping skeleton draw"),i.drawImage(L[n._cacheKey],0,0)):(p=3,i.save(),"MINION"===n.type&&(s(i,180*l,75*l,430*l,590*l),i.clip(),i.fillStyle="grey",i.fillRect(0,0,765*l,1100*l),i.drawImage(c,0,0,c.width,c.height,100*l,75*l,590*l,590*l)),"SPELL"===n.type&&(i.rect(125*l,165*l,529*l,434*l),i.clip(),i.fillStyle="grey",i.fillRect(0,0,765*l,1100*l),i.drawImage(c,0,0,c.width,c.height,125*l,117*l,529*l,529*l)),"WEAPON"===n.type&&(s(i,150*l,135*l,476*l,468*l),i.clip(),i.fillStyle="grey",i.fillRect(0,0,765*l,1100*l),i.drawImage(c,0,0,c.width,c.height,150*l,135*l,476*l,476*l)),i.restore(),p=4,i.drawImage(a(f.cardBack),0,0,764,1100,0,0,r.width,r.height),p=5,n.costHealth?(i.drawImage(a("health"),0,0,167,218,24*l,62*l,167*l,218*l),i.save(),i.shadowBlur=50*l,i.shadowColor="#FF7275",i.shadowOffsetX=1e3,i.globalAlpha=.5,i.drawImage(a("health"),0,0,167,218,24*l-1e3,62*l,167*l,218*l),i.restore()):i.drawImage(a("gem"),0,0,182,180,24*l,82*l,182*l,180*l),p=6,"MINION"===n.type&&(f.rarity&&i.drawImage(a(f.rarity),0,0,146,146,326*l,607*l,146*l,146*l),i.drawImage(a("title"),0,0,608,144,94*l,546*l,608*l,144*l),n.race&&i.drawImage(a("race"),0,0,529,106,125*l,937*l,529*l,106*l),i.drawImage(a("attack"),0,0,214,238,0,862*l,214*l,238*l),i.drawImage(a("health"),0,0,167,218,575*l,876*l,167*l,218*l),"LEGENDARY"===n.rarity&&i.drawImage(a("dragon"),0,0,569,417,196*l,0,569*l,417*l)),p=7,"SPELL"===n.type&&(f.rarity&&i.drawImage(a(f.rarity),0,0,149,149,311*l,607*l,150*l,150*l),i.drawImage(a("title-spell"),0,0,646,199,66*l,530*l,646*l,199*l)),"WEAPON"===n.type&&(f.rarity&&i.drawImage(a(f.rarity),0,0,146,144,315*l,592*l,146*l,144*l),i.drawImage(a("title-weapon"),0,0,660,140,56*l,551*l,660*l,140*l),i.drawImage(a("swords"),0,0,312,306,32*l,906*l,187*l,183*l),i.drawImage(a("shield"),0,0,301,333,584*l,890*l,186*l,205*l)),p=8,"CORE"!==n.set&&!function(){var e=256;n.race&&"MINION"===n.type?i.drawImage(a(f.bgLogo),0,0,281,244,e*l,734*l,266.95*l,244*.95*l):"SPELL"===n.type?i.drawImage(a(f.bgLogo),0,0,281,244,e*l,740*l,253*l,220*l):(i.globalAlpha=.6,i.drawImage(a(f.bgLogo),0,0,259,209,e*l,750*l,259*l,209*l),i.globalAlpha=1)}(),p=9,function(){var e=new Image;e.src=r.toDataURL(),L[n._cacheKey]=e}()),p=10,d(i,116,170,l,n.cost||0,170,n.costStyle),p=11,w(i,l,n),p=12,"MINION"===n.type&&(n.race&&h(i,l,n),d(i,128,994,l,n.attack||0,150,n.attackStyle),d(i,668,994,l,n.health||0,150,n.healthStyle)),p=13,"WEAPON"===n.type&&(d(i,128,994,l,n.attack||0,150,n.attackStyle),d(i,668,994,l,n.durability||0,150,n.durabilityStyle)),p=14,n.silenced&&"MINION"===n.type?i.drawImage(a("silence-x"),0,0,410,397,200*l,660*l,410*l,397*l):u(i,l,n),i.restore(),clearTimeout(y),e("Rendertime: "+(Date.now()-x)+"ms"),g(),o.target.src=r.toDataURL()}function f(e){S.push([e,this]),E||p()}function p(){I&&(x(),window.requestAnimationFrame(p))}function x(){if(!(E>C)){var i,a,n;if(S.length){var s=S.shift();E++,i=s[0],a=i.width,n=s[1];var o=t(a,Math.round(1.4397905759*a),!0),h=o.getContext("2d"),d=a/764,g=["silence-x","health"];if(i._assetsLoaded===a)return void y(o,h,i,d,n,function(){E--,e("Card rendered: "+i.title),r(o)});e("Preparing assets for: "+i.title),i.sunwell=i.sunwell||{},i.sunwell.cardBack=i.type.substr(0,1).toLowerCase()+i.playerClass.substr(0,1)+i.playerClass.substr(1).toLowerCase(),g.push(i.sunwell.cardBack),g.push("gem"),"MINION"===i.type&&(g.push("attack","title"),"LEGENDARY"===i.rarity&&g.push("dragon"),"FREE"===i.rarity||"COMMON"===i.rarity&&"CORE"===i.set||(i.sunwell.rarity="rarity-"+i.rarity.toLowerCase(),g.push(i.sunwell.rarity))),"SPELL"===i.type&&(g.push("attack","title-spell"),"FREE"===i.rarity||"COMMON"===i.rarity&&"CORE"===i.set||(i.sunwell.rarity="spell-rarity-"+i.rarity.toLowerCase(),g.push(i.sunwell.rarity))),"WEAPON"===i.type&&(g.push("swords","shield","title-weapon"),"FREE"===i.rarity||"COMMON"===i.rarity&&"CORE"===i.set||(i.sunwell.rarity="weapon-rarity-"+i.rarity.toLowerCase(),g.push(i.sunwell.rarity))),-1===["BRM","GVG","KARA","LOE","NAXX","TGT","OG"].indexOf(i.set)?i.sunwell.bgLogo="bg-cl":i.sunwell.bgLogo="bg-"+i.set.toLowerCase(),"SPELL"===i.type&&(i.sunwell.bgLogo="spell-"+i.sunwell.bgLogo),"WEAPON"===i.type&&(i.sunwell.bgLogo="w-"+i.sunwell.bgLogo),g.push(i.sunwell.bgLogo),i.race&&g.push("race"),"string"==typeof i.texture&&"CHEAT"!==i.set&&(.5>=d?g.push("h:"+i.texture):g.push("t:"+i.texture)),e("Assets prepared, now loading"),l(g).then(function(){e("Assets loaded for: "+i.title),i._assetsLoaded=a,y(o,h,i,d,n,function(){E--,e("Card rendered: "+i.title),r(o)})})}}}var b,m,v={},I=!1,S=[],C=12,E=0,L={},k=[],T=/(\d+)(.+?)\|4\((.+?),(.+?)\)/g,M=["COMMON","RARE","EPIC","LEGENDARY"];window.sunwell=b=window.sunwell||{},b._buffers=k,b._renderQuery=S,b._activeRenders=E,b.settings=b.settings||{},b.settings.titleFont=b.settings.titleFont||"Belwe Bold",b.settings.bodyFont=b.settings.bodyFont||"ITC Franklin Condensed",b.settings.bodyFontSize=b.settings.bodyFontSize||60,b.settings.bodyFontOffset=b.settings.bodyFontOffset||{x:0,y:0},b.settings.bodyLineHeight=b.settings.bodyLineHeight||50,b.settings.assetFolder=b.settings.assetFolder||"/assets/",b.settings.textureFolder=b.settings.textureFolder||"/artwork/",b.settings.smallTextureFolder=b.settings.smallTextureFolder||null,b.settings.autoInit=b.settings.autoInit||!0,b.settings.idAsTexture=b.settings.idAsTexture||!1,b.settings.debug=b.settings.debug||!1,b.init=function(){I=!0,S.length&&p()},b.settings.autoInit||b.init(),b.races={enUS:{MURLOC:"Murloc",MECHANICAL:"Mech",BEAST:"Beast",DEMON:"Demon",PIRATE:"Pirate",DRAGON:"Dragon",TOTEM:"Totem"},deDE:{MURLOC:"Murloc",MECHANICAL:"Mech",BEAST:"Wildtier",DEMON:"Dämon",PIRATE:"Pirat",DRAGON:"Drache",TOTEM:"Totem"}},b.clearCache=function(){L={}},b.Card=function(t,r,i){if(!t)throw new Error("No card properties given");i||(i=new Image),this.target=i,-1===M.indexOf(t.rarity)&&(t.rarity="FREE"),void 0===t.title&&(t.title=t.name),void 0===t.gameId&&(t.gameId=t.id),b.settings.idAsTexture&&(t.texture=t.gameId),t.costStyle=t.costStyle||"0",t.healthStyle=t.healthStyle||"0",t.attackStyle=t.attackStyle||"0",t.durabilityStyle=t.durabilityStyle||"0",t.silenced=t.silenced||!1,t.costHealth=t.costHealth||!1,t.width=r,t._cacheKey=n(t),this._props=t,e("Queried render: "+t.title),this._render=f.bind(this),this._render(this._props)},b.Card.prototype={target:null,_render:null,_props:null,redraw:function(){delete L[this._props._cacheKey],this._render(this._props)},update:function(e){for(var t in e)this._props[t]=e[t];this._props._cacheKey=n(this._props),this._render(this._props)}},b.createCard=function(e,t,r){return new b.Card(e,t,r)}}();