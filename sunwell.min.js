/**
 * Sunwell
 * =======
 * Sunwell is a renderer for hearthstone cards.
 *
 * @author Christian Engel <hello@wearekiss.com>
 */
(function(){function q(b){g.settings.debug&&console.log(b)}function y(){return w.length?w.pop():document.createElement("canvas")}function C(b){q("Substitute for "+b);if(v)return v;b=y();var c=b.getContext("2d");b.width=b.height=512;c.save();c.fillStyle="grey";c.fillRect(0,0,512,512);c.fill();c.fillStyle="red";c.textAlign="center";c.textBaseline="middle";c.font="50px Belwe";c.fillText("missing artwork",256,256);c.restore();v=new Image;v.src=b.toDataURL();return v}function n(b){return k[b]||C(b)}function D(b){var c,
d="",a=305419896;for(c in b)d=d+c+b[c];for(b=0;b<d.length;b++)a+=d.charCodeAt(b)*(b+1);return a}function J(b,c,d,a,f){var e=a/2*.5522848,m=f/2*.5522848,g=c+a,h=d+f;a=c+a/2;f=d+f/2;b.beginPath();b.moveTo(c,f);b.bezierCurveTo(c,f-m,a-e,d,a,d);b.bezierCurveTo(a+e,d,g,f-m,g,f);b.bezierCurveTo(g,f+m,a+e,h,a,h);b.bezierCurveTo(a-e,h,c,f+m,c,f);b.stroke()}function M(b){return new Promise(function(c){for(var d=0,a=1,f={},e,m,t,h,l=0;l<b.length;l++)e=b[l],t=m=!1,"h:"===e.substr(0,2)&&(m=!0,t=!!g.settings.smallTextureFolder,
e=e.substr(2)),"t:"===e.substr(0,2)&&(m=!0,e=e.substr(2),void 0!==k[e]&&256===k[e].width&&(k[e]=void 0)),"u:"===e.substr(0,2)&&(h=!0,e=e.substr(2)),void 0===k[e]?(k[e]=new Image,k[e].crossOrigin="Anonymous",k[e].loaded=!1,a++,function(b){k[b].addEventListener("load",function(){d++;k[b].loaded=!0;f[b]=k[b];k[b].width&&k[b].height||(k[b].src=C().src);d>=a&&c(f)});k[b].addEventListener("error",function(){d++;k[b].src=C().src;k[b].loaded=!0;f[b]=k[b];d>=a&&c(f)})}(e),h?k[e].src=e:(m?(k[e].isTexture=!0,
m=t?g.settings.smallTextureFolder+e+".jpg":g.settings.textureFolder+e+".jpg"):m=g.settings.assetFolder+e+".png",q("Requesting "+m),k[e].src=m)):(a++,k[e].loaded?(d++,f[e]=k[e]):function(b){k[b].addEventListener("load",function(){d++;f[b]=k[b];d>=a&&c(f)})}(e));a--;0<d&&d>=a&&c(f)})}function E(b){var c=b.canvas.width,d=b.canvas.height;b=b.getImageData(0,0,c,d).data;var a,f,e=999,m=999,g=0,h=0,l=!1;for(f=d-1;-1<f&&!l;f--)for(a=0;a<c;a++)if(0<b[4*f*c+4*a+3]){h=Math.max(h,f);l=!0;break}if(void 0===h)return null;
a=c-1;a:for(;-1<a;a--)for(f=0;f<d;f++)if(0<b[4*f*c+4*a+3]){g=Math.max(g,a);break a}a=0;a:for(;a<g;a++)for(f=0;f<d;f++)if(0<b[4*f*c+4*a+3]){e=Math.min(a,e);break a}f=0;a:for(;f<h;f++)for(a=0;a<c;a++)if(0<b[4*f*c+4*a+3]){m=Math.min(m,f);break a}return{x:e,y:m,maxX:g,maxY:h,w:g-e,h:h-m}}function N(b,c,d){var a,f;a=g.races[d.language]?g.races[d.language][d.race]?g.races[d.language][d.race]:d.race:g.races.enUS[d.race]?g.races.enUS[d.race]:d.race;d=y();var e=d.getContext("2d");d.width=300;d.height=60;e.font=
"45px Belwe";e.lineCap="round";e.lineJoin="round";e.textBaseline="hanging";e.textAlign="left";a=a.split("");f=10;for(var m=0;m<a.length;m++)e.lineWidth=8,e.strokeStyle="black",e.fillStyle="black",e.fillText(a[m],f,10),e.strokeText(a[m],f,10),e.fillStyle="white",e.strokeStyle="white",e.lineWidth=1,e.fillText(a[m],f,10),f+=e.measureText(a[m]).width;a=E(e);b.drawImage(d,a.x,a.y,a.w,a.h,(394-a.w/2)*c,(1001-a.h/2)*c,a.w*c,a.h*c);w.push(d)}function x(b,c,d,a,f,e,m){var g=y(),h=g.getContext("2d");void 0===
m&&(m="0");g.width=256;g.height=256;f=f.toString();f=f.split("");var l=10;h.font=e+"px Belwe";h.lineCap="round";h.lineJoin="round";h.textBaseline="hanging";h.textAlign="left";e="white";"-"===m&&(e="#f00");"+"===m&&(e="#0f0");for(m=0;m<f.length;m++)h.lineWidth=13,h.strokeStyle="black",h.fillStyle="black",h.fillText(f[m],l,10),h.strokeText(f[m],l,10),h.fillStyle=e,h.strokeStyle=e,h.lineWidth=2.5,h.fillText(f[m],l,10),l+=h.measureText(f[m]).width;f=E(h);b.drawImage(g,f.x,f.y,f.w,f.h,(c-f.w/2)*a,(d-f.h/
2)*a,f.w*a,f.h*a);w.push(g)}function F(b,c,d,a,f,e){g.settings.debug&&(b.save(),b.strokeStyle="red",b.beginPath(),b.moveTo(e/2-a/2,f),b.lineTo(e/2+a/2,f),b.stroke(),b.restore());e=e/2-a/2;0>e&&(e=0);0<a&&0<c.width&&b.drawImage(c,0,0,a>c.width?c.width:a,c.height,e,f,Math.min(a,c.width),c.height);a=5;f+=c.height;d.clearRect(0,0,c.width,c.height);return[a,f]}function O(b,c,d){var a=y(),f=a.getContext("2d"),e=y(),m=e.getContext("2d"),t=d.textMarkdown.replace(/[\$#_]/g,"").split(/( |\n)/g),h,l,u=0,p=0,
k,n,r,v;q("Rendering body: "+d.textMarkdown);a.width=520;a.height=290;e.width=520;"SPELL"===d.type&&(a.width=460,a.height=290,e.width=460);"WEAPON"===d.type&&(a.width=470,a.height=250,e.width=470);var z=g.settings.bodyFontSize;r=g.settings.bodyLineHeight;h=d.textMarkdown.replace(/\*\*/g,"").length;var x=!1;80<=h&&(z=.9*g.settings.bodyFontSize,r=.9*g.settings.bodyLineHeight);100<=h&&(z=.8*g.settings.bodyFontSize,r=.8*g.settings.bodyLineHeight);e.height=r;75<=h&&"SPELL"===d.type&&(x=!0);m.fillStyle=
"WEAPON"===d.type?"#fff":"#000";m.textBaseline="hanging";m.font=z+'px/1em "'+g.settings.bodyFont+'", sans-serif';for(r=0;r<t.length;r++){h=t[r];d=h.split("");l=m.measureText(h).width;q("Next word: "+h);if(u+l>e.width||x&&u+l>.8*e.width)q(u+l+" > "+e.width),q("Calculated line break"),x=!1,p=F(f,e,m,u,p,a.width),u=p[0],p=p[1],v=!0;for(h=0;h<d.length;h++)l=d[h],q(l+" "+l.charCodeAt(0)),10===l.charCodeAt(0)?v?v=!1:(p=F(f,e,m,u,p,a.width),u=p[0],p=p[1],q("Manual line break")):(v=!1,"*"===l||"_"===l?"*"===
d[h+1]?(k?(q("Normal"),k=!1,m.font=" "+z+'px/1em "'+g.settings.bodyFont+'", sans-serif'):(q("Bold"),k=!0,m.font="bold "+z+'px/1em "'+g.settings.bodyFont+'", sans-serif'),h+=1):n?(q("Normal"),n=!1,m.font=" "+z+'px/1em "'+g.settings.bodyFont+'", sans-serif'):(q("Italic"),n=!0,m.font="italic "+z+'px/1em "'+g.settings.bodyFont+'", sans-serif'):(m.fillText(l,u+g.settings.bodyFontOffset.x,g.settings.bodyFontOffset.y),u+=m.measureText(l).width+.375));u+=3}F(f,e,m,u,p,a.width);w.push(e);f=E(f);f.h=Math.ceil(f.h/
e.height)*e.height;b.drawImage(a,f.x,f.y-2,f.w,f.h,(390-f.w/2)*c,(860-f.h/2)*c,f.w*c,(f.h+2)*c);w.push(a);g.settings.debug&&(b.save(),b.strokeStyle="green",b.beginPath(),b.rect((390-f.w/2)*c,(860-f.h/2)*c,f.w*c,(f.h+2)*c),b.stroke(),b.strokeStyle="red",b.beginPath(),b.rect((390-a.width/2)*c,(860-a.height/2)*c,a.width*c,(a.height+2)*c),b.stroke(),b.restore())}function G(b,c){return{x:Math.pow(1-c,3)*b[0].x+3*Math.pow(1-c,2)*c*b[1].x+3*(1-c)*Math.pow(c,2)*b[2].x+Math.pow(c,3)*b[3].x,y:Math.pow(1-c,
3)*b[0].y+3*Math.pow(1-c,2)*c*b[1].y+3*(1-c)*Math.pow(c,2)*b[2].y+Math.pow(c,3)*b[3].y,r:Math.atan2(3*Math.pow(1-c,2)*(b[1].y-b[0].y)+6*(1-c)*c*(b[2].y-b[1].y)+3*Math.pow(c,2)*(b[3].y-b[2].y),3*Math.pow(1-c,2)*(b[1].x-b[0].x)+6*(1-c)*c*(b[2].x-b[1].x)+3*Math.pow(c,2)*(b[3].x-b[2].x))}}function P(b,c,d){var a=y(),f=d.title;a.width=1024;a.height=200;var e=a.getContext("2d");e.save();var m=.58,t=580,h=[{x:0,y:110},{x:102,y:137},{x:368,y:16},{x:580,y:100}];"SPELL"===d.type&&(m=.52,t=580,h=[{x:10,y:100},
{x:212,y:35},{x:368,y:35},{x:570,y:105}]);"WEAPON"===d.type&&(m=.58,t=580,h=[{x:10,y:75},{x:50,y:75},{x:500,y:75},{x:570,y:75}]);d=51;e.lineWidth=13;e.strokeStyle="black";e.lineCap="round";e.lineJoin="round";e.textAlign="left";e.textBaseline="middle";for(var l=t+1;l>t&&10<d;){--d;e.font=d+"px Belwe";for(var k=l=0;k<f.length;k++)l+=e.measureText(f[k]).width+2;l*=1.25}l/=t;m-=l/2;t=l/f.length;g.settings.debug&&(e.save(),e.strokeStyle="red",e.lineWidth=5,e.beginPath(),e.moveTo(h[0].x,h[0].y),e.bezierCurveTo(h[1].x,
h[1].y,h[2].x,h[2].y,h[3].x,h[3].y),e.stroke(),e.restore());for(var p,n,k=l=0;k<f.length;k++){if(0===l)n=m+t*k,p=G(h,n),l=p.x;else for(n+=.01,p=G(h,n);p.x<l;)n+=.001,p=G(h,n);e.save();e.translate(p.x,p.y);e.scale(1.2,1);e.rotate(p.r);e.lineWidth=d/50*10;e.strokeStyle="black";e.fillStyle="black";e.fillText(f[k],0,0);e.strokeText(f[k],0,0);p=1.25*e.measureText(f[k]).width;l+=p;-1!==["i","f"].indexOf(f[k])&&(l+=.1*p);e.fillStyle="white";e.strokeStyle="white";e.lineWidth=d/50*2.5;e.fillText(f[k],0,0);
e.restore()}b.drawImage(a,0,0,580,200,105*c,525*c,580*c,200*c);w.push(a)}function Q(b,c,d,a,f,e){var g=d.sunwell,k,h,l=0,r=Date.now();h=setTimeout(function(){q("Drawing timeout at point "+l+" in "+d.title);q(d);e();f&&f(b)},5E3);"string"===typeof d.texture?k=n(d.texture):d.texture instanceof Image?k=d.texture:(k=y(),k.width=d.texture.crop.w,k.height=d.texture.crop.h,k.getContext("2d").drawImage(d.texture.image,d.texture.crop.x,d.texture.crop.y,d.texture.crop.w,d.texture.crop.h,0,0,k.width,k.height));
k||(k=n("~"));l=2;c.save();c.clearRect(0,0,b.width,b.height);l=3;c.save();"MINION"===d.type&&(J(c,180*a,75*a,430*a,590*a),c.clip(),c.fillStyle="grey",c.fillRect(0,0,765*a,1100*a),c.drawImage(k,0,0,k.width,k.height,100*a,75*a,590*a,590*a));"SPELL"===d.type&&(c.rect(125*a,165*a,529*a,434*a),c.clip(),c.fillStyle="grey",c.fillRect(0,0,765*a,1100*a),c.drawImage(k,0,0,k.width,k.height,125*a,117*a,529*a,529*a));"WEAPON"===d.type&&(J(c,150*a,135*a,476*a,468*a),c.clip(),c.fillStyle="grey",c.fillRect(0,0,765*
a,1100*a),c.drawImage(k,0,0,k.width,k.height,150*a,135*a,476*a,476*a));c.restore();l=4;c.drawImage(n(g.cardBack),0,0,764,1100,0,0,b.width,b.height);l=5;c.drawImage(n("gem"),0,0,182,180,24*a,82*a,182*a,180*a);l=6;"MINION"===d.type&&(g.rarity&&c.drawImage(n(g.rarity),0,0,146,146,326*a,607*a,146*a,146*a),c.drawImage(n("title"),0,0,608,144,94*a,546*a,608*a,144*a),d.race&&c.drawImage(n("race"),0,0,529,106,125*a,937*a,529*a,106*a),c.drawImage(n("attack"),0,0,214,238,0,862*a,214*a,238*a),c.drawImage(n("health"),
0,0,167,218,575*a,876*a,167*a,218*a),"LEGENDARY"===d.rarity&&c.drawImage(n("dragon"),0,0,569,417,196*a,0,569*a,417*a));l=7;"SPELL"===d.type&&(g.rarity&&c.drawImage(n(g.rarity),0,0,149,149,311*a,607*a,150*a,150*a),c.drawImage(n("title-spell"),0,0,646,199,66*a,530*a,646*a,199*a));"WEAPON"===d.type&&(g.rarity&&c.drawImage(n(g.rarity),0,0,146,144,315*a,592*a,146*a,144*a),c.drawImage(n("title-weapon"),0,0,660,140,56*a,551*a,660*a,140*a),c.drawImage(n("swords"),0,0,312,306,32*a,906*a,187*a,183*a),c.drawImage(n("shield"),
0,0,301,333,584*a,890*a,186*a,205*a));l=8;"CORE"!==d.set&&function(){var b;"SPELL"===d.type&&(b=265);"MINION"===d.type&&(b=265);d.race&&"MINION"===d.type?c.drawImage(n(g.bgLogo),0,0,281,244,b*a,734*a,266.95*a,244*.95*a):"SPELL"===d.type?c.drawImage(n(g.bgLogo),0,0,281,244,b*a,740*a,253*a,220*a):c.drawImage(n(g.bgLogo),0,0,281,244,b*a,734*a,281*a,244*a)}();l=9;l=10;x(c,116,170,a,d.cost||0,170,d.costStyle);l=11;P(c,a,d);l=12;"MINION"===d.type&&(d.race&&N(c,a,d),x(c,128,994,a,d.attack||0,150,d.attackStyle),
x(c,668,994,a,d.health||0,150,d.healthStyle));l=13;"WEAPON"===d.type&&(x(c,128,994,a,d.attack||0,150,d.attackStyle),x(c,668,994,a,d.durability||0,150,d.durabilityStyle));l=14;d.silenced&&"MINION"===d.type?c.drawImage(n("silence-x"),0,0,410,397,200*a,660*a,410*a,397*a):O(c,a,d);c.restore();clearTimeout(h);q("Rendertime: "+(Date.now()-r)+"ms");e();f&&f(b)}function H(b,c,d){A.push([b,c,d]);B||I()}function I(){K&&(R(),window.requestAnimationFrame(I))}function R(){if(!(12<B)){var b,c,d;if(A.length){var a=
A.shift();B++;b=a[0];c=a[1];d=a[2];q("Preparing assets for: "+b.title);var f=y(),e=f.getContext("2d"),g=(c||512)/764,a=["silence-x"];f.width=c||512;f.height=Math.round(1.4397905759*f.width);b.sunwell=b.sunwell||{};b.sunwell.cardBack=b.type.substr(0,1).toLowerCase()+b.playerClass.substr(0,1)+b.playerClass.substr(1).toLowerCase();a.push(b.sunwell.cardBack);a.push("gem");"MINION"===b.type&&(a.push("attack","health","title"),"LEGENDARY"===b.rarity&&a.push("dragon"),"FREE"===b.rarity||"COMMON"===b.rarity&&
"CORE"===b.set||(b.sunwell.rarity="rarity-"+b.rarity.toLowerCase(),a.push(b.sunwell.rarity)));"SPELL"===b.type&&(a.push("attack","health","title-spell"),"FREE"===b.rarity||"COMMON"===b.rarity&&"CORE"===b.set||(b.sunwell.rarity="spell-rarity-"+b.rarity.toLowerCase(),a.push(b.sunwell.rarity)));"WEAPON"===b.type&&(a.push("swords","shield","title-weapon"),"FREE"===b.rarity||"COMMON"===b.rarity&&"CORE"===b.set||(b.sunwell.rarity="weapon-rarity-"+b.rarity.toLowerCase(),a.push(b.sunwell.rarity)));-1==="BRM GVG LOE NAX TGT OG".split(" ").indexOf(b.set)?
b.sunwell.bgLogo="bg-cl":b.sunwell.bgLogo="bg-"+b.set.toLowerCase();"SPELL"===b.type&&(b.sunwell.bgLogo="spell-"+b.sunwell.bgLogo);a.push(b.sunwell.bgLogo);b.race&&a.push("race");"string"===typeof b.texture&&"CHEAT"!==b.set&&(.5>=g?a.push("h:"+b.texture):a.push("t:"+b.texture));q("Assets prepared, now loading");M(a).then(function(){q("Assets loaded for: "+b.title);Q(f,e,b,g,d,function(){B--;q("Card rendered: "+b.title);w.push(f)})})}}}function L(b){return b.replace(/<\/*b>/g,"**").replace(/<\/*i>/g,
"*")}var g,k={},K=!1,A=[],B=0,r={},w=[],S=["COMMON","RARE","EPIC","LEGENDARY"],v;window.sunwell=g=window.sunwell||{};g._buffers=w;g._renderQuery=A;g._activeRenders=B;g.settings=g.settings||{};g.settings.titleFont=g.settings.titleFont||"Belwe Bold";g.settings.bodyFont=g.settings.bodyFont||"ITC Franklin Condensed";g.settings.bodyFontSize=g.settings.bodyFontSize||60;g.settings.bodyFontOffset=g.settings.bodyFontOffset||{x:0,y:0};g.settings.bodyLineHeight=g.settings.bodyLineHeight||50;g.settings.assetFolder=
g.settings.assetFolder||"/assets/";g.settings.textureFolder=g.settings.textureFolder||"/artwork/";g.settings.smallTextureFolder=g.settings.smallTextureFolder||null;g.settings.autoInit=g.settings.autoInit||!0;g.settings.idAsTexture=g.settings.idAsTexture||!1;g.settings.debug=g.settings.debug||!1;g.init=function(){K=!0;A.length&&I()};g.settings.autoInit||g.init();g.races={enUS:{MURLOC:"Murloc",MECHANICAL:"Mech",BEAST:"Beast",DEMON:"Demon",PIRATE:"Pirate",DRAGON:"Dragon",TOTEM:"Totem"},deDE:{MURLOC:"Murloc",
MECHANICAL:"Mech",BEAST:"Wildtier",DEMON:"D\u00e4mon",PIRATE:"Pirat",DRAGON:"Drache",TOTEM:"Totem"}};g.clearCache=function(){r={}};g.createCard=function(b,c,d){if(!b)throw Error("No card object given");d||(d=new Image);-1===S.indexOf(b.rarity)&&(b.rarity="FREE");void 0===b.title&&(b.title=b.name);void 0===b.gameId&&(b.gameId=b.id);b.textMarkdown=L(b.text);b.textMarkdown=b.textMarkdown.replace(/^\[x]/,"");g.settings.idAsTexture&&(b.texture=b.gameId);b.costStyle=b.costStyle||"0";b.healthStyle=b.healthStyle||
"0";b.attackStyle=b.attackStyle||"0";b.durabilityStyle=b.durabilityStyle||"0";b.silenced=b.silenced||!1;b.width=c;var a=D(b);if(r[a]&&!g.settings.debug)d.src=r[a];else return q("Queried render: "+b.title),H(b,c,function(b){d.src=r[a]=b.toDataURL()}),{target:d,redraw:function(){a=D(b);delete r[a];H(b,c,function(b){d.src=r[a]=b.toDataURL()})},update:function(f){f.text&&(f.markdown=L(f.text));f.markdown&&(f.textMarkdown=f.textMarkdown.replace(/^\[x]/,""));for(var e in f)b[e]=f[e];a=D(b);r[a]?d.src=r[a]:
H(b,c,function(b){d.src=r[a]=b.toDataURL()})}}}})();